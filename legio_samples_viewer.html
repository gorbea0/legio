<!DOCTYPE html>
<html lang="es">
<head>


<!-- Leaflet core -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Geocoder (para buscar calles) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>




  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LEGIO Samples Viewer OUS</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  
  /* Rayado alterno por grupos (muy suave) */
.tr-group-a { background: #fafcff; } /* azul muy, muy p√°lido */
.tr-group-b { background: #f9fcfa; } /* verde muy, muy p√°lido */

/* El hover debe imponerse al rayado */
tbody tr:hover { background: #f3f4f6 !important; }



  /* Rayado por grupos: A/B. Se aplica en las CELDAS para que no
     lo tapen utilidades tipo bg-white, etc. */
  table.striped tbody tr.tr-group-a > td { background-color: #f8fbff !important; } /* azul MUY suave */
  table.striped tbody tr.tr-group-b > td { background-color: #f7fff8 !important; } /* verde MUY suave */

  /* El hover gris debe dominar el rayado */
  table.striped tbody tr:hover > td { background-color: #f3f4f6 !important; }

  
  /* Estadistica */
/* Modal de estad√≠sticas con cuerpo desplazable */
#statsModal .stats-body{
  max-height: 70vh;          /* el contenido del modal no crece sin l√≠mite */
  overflow: auto;            /* scroll interno si hace falta */
}

/* Altura fija de cada gr√°fico */
#statsModal .chart-wrap{
  height: 280px;             /* puedes subir/bajar este valor */
}

/* Un poco m√°s alto en pantallas grandes */
@media (min-width: 1024px){
  #statsModal .chart-wrap{ height: 320px; }
}


  
  /* Calendario */
  
  
 
  #calDayList ul{
    max-height: 320px;    /* ajusta a tu gusto */
    overflow-y: auto;
  }


.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: .25rem;
  font-size: 12px;
}
.cal-month {
  border: 1px solid #e8eef5;
  border-radius: .75rem;
  padding: .75rem;
  background: #fff;
}
.cal-month .cal-header {
  font-weight: 600;
  margin-bottom: .5rem;
  text-align: center;
}
.cal-dow {
  text-align: center;
  color: #475569;
  font-size: 11px;
  padding: .15rem 0;
}
.cal-day {
  border-radius: .6rem;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: default;
  user-select: none;
}
.cal-day.out { color: #cbd5e1; }
.cal-day.in { cursor: pointer; }
.cal-day:hover.in { outline: 2px solid #c7d2fe; outline-offset: 1px; }

/* Marcadores de presencia */
.cal-day.has-iso    { background: rgba(59,130,246,.18); }  /* azul suave */
.cal-day.has-idex   { background: rgba(34,197,94,.18); }   /* verde suave */
.cal-day.has-both   { background: rgba(168,85,247,.20); }  /* violeta suave */
.cal-day.today { border: 1px dashed #64748b; }

/* Lista de muestras bajo el calendario */
#calDayList .day-title {
  font-weight: 600; margin: .25rem 0 .5rem 0;
}
#calDayList ul { margin: 0; padding: 0; list-style: none; }
#calDayList li {
  padding: .4rem .6rem; border-radius: .6rem; border: 1px solid #e8eef5;
  margin-bottom: .35rem; background: #fff; cursor: pointer;
}
#calDayList li:hover { background: #f8fafc; }
.badge {
  display: inline-block; font-size: 10px; border-radius: .35rem; padding: .05rem .35rem;
  margin-left: .35rem; border: 1px solid transparent;
}
.badge.iso  { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
.badge.idex { background: #ecfdf5; color: #15803d; border-color: #bbf7d0; }

  </style>
  <style>
    .row-line{display:flex;align-items:center;gap:.75rem;padding:.4rem .25rem;border-bottom:1px solid #eee}
    .row-line:last-child{border-bottom:none}
    .row-analysis{font-size:11px;color:#6b7280;width:130px;flex:0 0 auto}
    .row-main{flex:1 1 auto;min-width:0;display:flex;align-items:center;gap:.5rem}
    .row-component{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:50%}
    .row-sep{color:#9ca3af}
    .row-result{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40%}
    .badge{padding:.15rem .5rem;border-radius:9999px;font-size:11px;white-space:nowrap;flex:0 0 auto}
    .b-ok{background:#DCFCE7;color:#166534}
    .b-poco{background:#FEF9C3;color:#92400E}
    .b-positivo{background:#FFEDD5;color:#9A3412}
    .b-alto{background:#FEE2E2;color:#991B1B}
    .b-muyalto{background:#EDE9FE;color:#5B21B6}
    .b-incumple{background:#F87171;color:#fff}
    .btn-tab{background:#DBEAFE;border-radius:.5rem;padding:.25rem .6rem}
    .btn-tab:hover{background:#BFDBFE}
    .btn-tab.active{background:#2563EB;color:#fff}
    .btn-danger{background:#FEE2E2}
    .btn-danger:hover{background:#FCA5A5}
    .btn-danger.active{background:#DC2626;color:#fff}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .55rem;border-radius:9999px;background:#F3F4F6;font-size:12px}
    .chip b{font-weight:600}
    .pill{border:1px solid #d1d5db;border-radius:9999px;padding:.2rem .6rem;font-size:.75rem;background:#fff}
    .pill.active{background:#2563EB;color:#fff;border-color:#2563EB}
    .accordion-btn{width:100%;text-align:left}
    .hist-grid{display:grid;grid-template-columns: 110px 110px 1fr 1fr;gap:.5rem;align-items:center}
    .hist-head{font-size:.75rem;color:#6b7280}
    .table{min-width:100%;font-size:.875rem;border:1px solid #d1d5db;border-collapse:collapse}
    .table th,.table td{border:1px solid #d1d5db;padding:.5rem}
    .table thead tr{background:#e5e7eb}
  </style>
  <style>
  #cabeceraMuestra > div {
    padding: 0.25rem 0.5rem; /* reduce alto interno */
    font-size: 0.85rem;       /* texto un poco m√°s peque√±o */
  }
  #chipsExtra {
    padding: 0.25rem 0; /* menos alto en el contenedor de chips */
  }
  #chipsExtra .chip {
    padding: 0.15rem 0.4rem; /* menos alto en cada chip */
    font-size: 0.8rem;       /* texto m√°s peque√±o en chips */
  }
  
  
  /* Panel lateral del mapa siempre por encima del canvas del mapa */
#mapCasesPanel{
  position:absolute;
  right:12px;
  top:84px;        /* ajusta si quieres m√°s arriba/abajo */
  z-index:1100;    /* por encima de los tiles/markers */
  width: 260px;
  max-height: 62vh;
  overflow:auto;
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.18);
  padding:10px 12px;
}
#mapCasesPanel h4{ margin: 6px 0 8px; }
#mapCasesPanel .year{ font-weight:600; margin-top:10px; }

 /* El canvas del mapa debe estar por debajo de los overlays */
#mapModal .leaflet-container { z-index: 1000; }

/* Nuestro panel */
#mapControls { z-index: 1002; }

/* Control de capas base de Leaflet por encima de todo */
#mapModal .leaflet-top.leaflet-right { z-index: 1004; }
 
  
</style>
</head>
<body class="bg-gray-50 font-sans">
  <div class="container mx-auto p-4">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-xl font-bold">üß™ LEGIO DEMSAC Samples Viewer</h1><span id="remoteCsvMsg"></span>
      <div class="text-xs text-gray-500">OUS</div>
    </div>
<div class="mb-4">
  <button id="toggleManualBtn" class="btn-tab" type="button">
    üì• Carga manual de CSV
  </button>

  <div id="manualCsvWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 hidden">
    <div>
      <label class="font-semibold">üìÅ CSV de registro:</label>
      <input type="file" id="csvInputMain" accept=".csv" class="block w-full border p-2 rounded">
    </div>
    <div>
      <label class="font-semibold">üìÅ CSV de an√°lisis:</label>
      <input type="file" id="csvInputDetails" accept=".csv" class="block w-full border p-2 rounded">
    </div>
  </div>
</div>



    <div class="mb-4">
      <div class="w-full">
        <canvas id="samplesChart" style="height:240px;width:100%"></canvas>
      </div>
      <div class="text-xs text-gray-500 mt-1">üí° Pulsa sobre una barra <b>Positivos</b> para filtrar la tabla.</div>
    </div>

    <div id="tabs" class="mb-3 hidden">
      <ul class="flex flex-wrap gap-2" id="tabButtons"></ul>
    </div>

    <!-- Buscador -->
    <div id="searchTab" class="hidden mb-3">
      <div class="flex items-center gap-2 mb-2">
        <button id="modePoint" class="pill active">Sampling point</button>
        <button id="modeId" class="pill">Id Numeric</button>
      </div>
      <div class="flex gap-2 items-center" id="searchInputs">
        <input type="text" id="searchInputPoint" placeholder="Buscar por Sampling point..." class="border p-2 rounded w-full">
        <input type="text" id="searchInputId" placeholder="Buscar por Id Numeric..." class="border p-2 rounded w-64 hidden">
        <button id="clearSearch" class="btn-tab">Limpiar</button>
      </div>
      <div id="searchResults" class="overflow-auto max-h-96 mt-2"></div>
    </div>
	
	<!-- Botones extra -->
	
	   <button id="fechasIntervalo" class="btn-sky">
	  üìÖ Seleccionar fechas
         </button>
<button class="btn-sky" onclick="openCalendarModal()">
  üìÖ Calendario
</button>
<button class="btn-slate" onclick="openMapModal()">
  üó∫Ô∏è Mapa
</button>
<button class="btn-slate" onclick="openStatsModal()">
  üìà Estad√≠stica
</button>

	
<!-- Contador de muestras activas -->
<span id="activeCount"
      style="margin-left:.75rem;padding:.15rem .5rem;border-radius:.5rem;
             background:#eef2ff;color:#1f2937;font-weight:600;
             border:1px solid #c7d2fe;white-space:nowrap;">
  0 muestras activas
</span>
	

    <div id="tabContent" class="overflow-auto border border-gray-300 rounded p-2 bg-white"></div>

  </div>

  <!-- Modal detalle -->
  <div id="modalDetalle" class="fixed inset-0 hidden z-50 flex items-start justify-center bg-black/40">
  <div class="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-5xl mt-1 max-h-[92vh] overflow-y-auto">

      <div class="px-5 py-3 border-b flex items-center justify-between">
        <h2 id="tituloModal" class="text-lg font-semibold">üß¨ Detalles de la muestra</h2>
        <button id="cerrarModalBtn" class="text-gray-500 hover:text-red-600 text-xl leading-none">√ó</button>
      </div>
      <div class="p-5 space-y-4">
        <div id="cabeceraMuestra" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
        <div id="chipsExtra" class="flex flex-wrap gap-2"></div>

        <!-- Acorde√≥n Par√°metros -->
        <div class="border rounded-xl">
          <button id="btnParams" class="accordion-btn px-4 py-2 font-medium flex items-center justify-between">
            <span>üßæ Par√°metros</span>
            <span id="caretParams" class="ml-2">‚ñ∂</span>
          </button>
          <div id="paramsContent" class="hidden px-4 pb-3">
            <div id="contenidoDetalle" class="text-sm max-h-[35vh] overflow-y-auto"></div>
          </div>
        </div>

        <!-- Acorde√≥n historial: listado -->
        <div class="border rounded-xl">
          <button id="btnHistList" class="accordion-btn px-4 py-2 font-medium flex items-center justify-between">
            <span>üìú Historial (listado)</span>
            <span id="caretHistList" class="ml-2">‚ñº</span>
          </button>
          <div id="histListContent" class="px-4 pb-3 space-y-2">
            <div class="max-h-[26vh] overflow-y-auto">
              <div class="hist-grid hist-head px-1 py-1">
                <div>Fecha</div><div>Id</div><div>Legionella</div><div>Temp (¬∞C)</div>
              </div>
              <div id="histList" class="divide-y"></div>
            </div>
          </div>
        </div>

        <!-- Acorde√≥n historial: gr√°fico -->
        <div class="border rounded-xl">
          <button id="btnHistChart" class="accordion-btn px-4 py-2 font-medium flex items-center justify-between">
            <span>üìà Evoluci√≥n</span>
            <span id="caretHistChart" class="ml-2">‚ñ∂</span>
          </button>
          <div id="histChartContent" class="hidden px-4 pb-4">
            <div class="border rounded-xl p-3">
              <canvas id="histChart" height="80"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<!-- ============== Calendario (modal) ============== -->
<div id="calendarModal" class="fixed inset-0 z-30 hidden items-start justify-center bg-black/40 px-2 py-2">
  <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl p-4 mt-2">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <button id="calPrev" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">‚Üê</button>
        <div id="calTitle" class="text-lg font-semibold"></div>
        <button id="calNext" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">‚Üí</button>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="cal-day has-iso px-2 rounded">ISO (1 L)</span>
        <span class="cal-day has-idex px-2 rounded">IDEX (500 ml)</span>
        <span class="cal-day has-both px-2 rounded">Mixto</span>
		 <span > ‚ö†Ô∏è Caso legio</span>
      </div>
      <button class="text-gray-500 hover:text-red-600 text-xl" onclick="closeCalendarModal()">√ó</button>
    </div>

    <!-- 3 meses -->
    <div id="calMonths" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>

    <!-- Lista del d√≠a -->
    <div id="calDayList" class="mt-3">
      <div class="day-title text-sm text-gray-500"></div>
      <ul></ul>
    </div>
  </div>
</div>


<!-- ===== Estad√≠stica - Modal ===== -->



<!-- ===== Estad√≠stica - Modal (limpio) ===== -->
<div id="statsModal" class="fixed inset-0 z-[70] hidden items-start justify-center bg-black/40 px-2 py-3">
  <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="text-lg font-semibold">üìà Estad√≠sticas: ¬°Para el filtro que has seleccionado (fechas/tipos)!</div>
      <button class="text-gray-500 hover:text-red-600 text-xl" onclick="closeStatsModal()">√ó</button>
    </div>

    <!-- cuerpo desplazable -->
    <div class="stats-body space-y-6">
      <!-- A. Barras por Test schedule -->
      <section class="bg-white rounded-xl shadow p-4">
        <div class="font-semibold mb-2">Muestras por ‚ÄúTest schedule‚Äù</div>
        <div class="chart-wrap">
          <canvas id="chartBySchedule"></canvas>
        </div>
      </section>

      <!-- B. Evoluci√≥n anual (total vs positivos) + selector tipo -->
      <section class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">Evoluci√≥n anual (total vs positivos)</div>
          <select id="evoTypeSelect" class="border rounded px-2 py-1 text-sm"></select>
        </div>
        <div class="chart-wrap">
          <canvas id="chartYearEvolution"></canvas>
        </div>
      </section>

      <!-- C. Rankings -->
      <section class="bg-white rounded-xl shadow p-4">
        <details open>
          <summary class="cursor-pointer text-base font-medium">
            Ranking: puntos con m√°s positivos de Legionella (√∫ltimos 3 a√±os) 
          </summary>
          <ol id="rankLegio" class="mt-2 space-y-1 list-decimal list-inside text-sm"></ol>
        </details>

        <details class="mt-3" open>
          <summary class="cursor-pointer text-base font-medium">
            Ranking: ACS con m√°s incumplimientos de temperatura &lt; 50 ¬∞C (√∫ltimos 3 a√±os) 
          </summary>
          <ol id="rankTemp" class="mt-2 space-y-1 list-decimal list-inside text-sm"></ol>
        </details>
      </section>
	  
	  
	  
	  <!-- D. Tipos por a√±o (barras apiladas) -->
<section>
  <h4 class="text-base font-medium mb-2">Muestras por tipo y a√±o </h4>
  <div class="chart-wrap">
  <canvas id="chartTypesYearly" height="160"></canvas>
   </div>
  
</section>

<!-- E. Test schedule por a√±o (barras apiladas) -->
<section>
  <h4 class="text-base font-medium mb-2">Muestras por Test schedule</h4>
  <div class="chart-wrap">
  <canvas id="chartScheduleYearly" height="160"></canvas>
   </div>
</section>

	  
	  
	  
	  
	  
	  
	  
    </div>
  </div>
</div>

<style>
  /* para el modal */
  #statsModal .chartjs-render-monitor { max-height: 380px; }
</style>

<!-- ============== Mapa (modal) ============== -->

<!-- ===== Mapa (modal) ===== -->
<div id="mapModal" class="fixed inset-0 z-[80] hidden items-start justify-center bg-black/40 px-2 py-2">
  <div class="bg-white w-full h-[90vh] max-w-7xl rounded-2xl shadow-2xl relative overflow-hidden">

    <!-- Barra superior -->
    <div id="mapToolbar" class="flex items-center justify-between gap-3 px-3 py-2 border-b">
      <div class="font-semibold">Mapa de puntos con aerosol y casos de legionelosis en Vitoria</div>
      <button class="text-gray-500 hover:text-red-600 text-xl" onclick="closeMapModal()">√ó</button>
    </div>


    <!-- Controles superpuestos (encima del mapa, esquina superior derecha) -->
<div id="mapControls"
     class="absolute right-3 top-[calc(var(--map-toolbar-h,56px)+10px)] z-[1002] bg-white/95 backdrop-blur rounded-xl shadow p-3 w-[320px] pointer-events-auto">

  <details open>
    <summary class="cursor-pointer text-sm font-medium mb-2">üóÉÔ∏è Capas y üîç b√∫squeda</summary>

    <!-- Tipos de punto -->
    <div class="flex flex-wrap items-center gap-3 text-sm mb-2">
      <label class="inline-flex items-center gap-1">
        <input type="checkbox" id="chkFnt" checked>‚õ≤Ô∏è Fuentes ornamentales
      </label>
      <label class="inline-flex items-center gap-1">
        <input type="checkbox" id="chkLav" checked> üßΩ Lavacoches
      </label>
      <label class="inline-flex items-center gap-1">
        <input type="checkbox" id="chkTor" checked> üè¢ Torres
      </label>
    </div>








    <!-- B√∫squeda interna por Sampling point / nombre -->
    <input id="mapSearchSp"
           class="border rounded px-2 py-1 text-sm w-full mb-2"
           placeholder="Buscar Sampling point o nombre..." />

    <!-- B√∫squeda de calle (Nominatim) -->
    <div class="flex gap-1">
      <input id="mapSearchStreet"
             class="border rounded px-2 py-1 text-sm w-full"
             placeholder="Buscar calle/dir (Nominatim)..." />
      <button id="btnStreet"
              class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">Buscar</button>
    </div>
  </details>

  <!-- Lista de casos, agrupada por a√±o -->
  
  
  
  
  <details open class="mt-3">
  <summary class="cursor-pointer text-sm font-medium">‚ò†Ô∏è Casos (on/off)</summary>

  <!-- NUEVO: master on/off -->
  <label class="flex items-center gap-2 mt-2 text-sm">
    <input type="checkbox" id="chkCasesAll" checked>
    <span>Todos los casos</span>
  </label>

  <div id="casesList" class="mt-2 space-y-1 max-h-48 overflow-auto text-sm pr-1"></div>
</details>

  
  
  
  
  
  
 
</div>


    <!-- Rosa de los vientos (esquina inferior derecha) -->
    <div id="windRose"
         class="absolute bottom-3 right-3 z-[1002] bg-white/90 rounded-full shadow p-2 text-xs select-none pointer-events-none">
      <div class="w-12 h-12 relative">
        <div class="absolute inset-0 rounded-full border border-gray-300"></div>
        <div class="absolute left-1/2 top-0 -translate-x-1/2 text-gray-600">N</div>
        <div class="absolute right-0 top-1/2 -translate-y-1/2 text-gray-600">E</div>
        <div class="absolute left-1/2 bottom-0 -translate-x-1/2 text-gray-600">S</div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 text-gray-600">O</div>
      </div>
    </div>

    <!-- El mapa ocupa todo el hueco disponible debajo de la toolbar -->
    <div id="map"
         class="absolute left-2 right-2 bottom-2 rounded-lg z-[1000]"
         style="top: calc(var(--map-toolbar-h, 56px) + 8px);">
    </div>
  </div>
</div>

<style>
  /* El canvas del mapa debe estar por debajo de los overlays */
  #mapModal .leaflet-container { z-index: 1000; }
  #mapControls, #windRose { z-index: 1002; }


  /* Ajustes visuales de iconos de marcador (divIcon) */
.ico.fuente, .ico.lavacoches, .ico.torre, .ico.skull{
  font-size: 26px;   /* antes 18px */
  line-height: 1;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,.4));
}
.leaflet-popup-content .js-open-line:hover {
  background:#f3f4f6; border-radius:6px;
}


</style>

<script>



// ========= ENCODING PATCH  =========
// --- Lectura de CSV con codificaci√≥n robusta ---
// 1) intenta UTF-8 estricto; si no es v√°lido, cae a Windows-1252.
async function readFileSmartENC(file){
  const buf = await file.arrayBuffer();
  const u8  = new Uint8Array(buf);

  // UTF-8 estricto (si no es v√°lido, lanzar√° excepci√≥n)
  try {
    return new TextDecoder('utf-8', { fatal: true }).decode(u8);
  } catch {
    // Fallback a Windows-1252 (Latin-1 compatible en muchos CSV antiguos)
    try {
      return new TextDecoder('windows-1252').decode(u8);
    } catch {
      // √öltimo recurso: lo que d√© el navegador
      return await file.text();
    }
  }
}


// Limpia encabezados: BOM y nbsp
function cleanHeaderENC(h){
  return String(h ?? "")
    .replace(/^\uFEFF/, '')   // BOM
    .replace(/\u00A0/g, ' ')  // NBSP
    .trim();
}

// Normaliza solo campos de texto 
function normCellENC(v){
  return (typeof v === "string") ? String(v).normalize("NFKC").trim() : v;
}








function hasSer1ForId(id){
  id = String(id || "").trim();
  if (!id || !Array.isArray(allDetails)) return false;

  return allDetails.some(r => {
    const rId = String(r["Id Numeric"] || r["Id numeric"] || "").trim();
    if (rId !== id) return false;

    const comp = String(r["Component Name"] || "").toLowerCase().replace(/\s+/g, " ").trim();
    const anal = String(r["Analysis"] || "").toUpperCase().replace(/\s+/g, " ").trim();
    const valTextRaw = String(r["Result text"] || "").toLowerCase().replace(/\s+/g, " ").trim();

    // Detecta si es serotipo 1
    const isSer1 =
      comp.includes("serotipo 1") ||
      comp.includes("sr 1") ||
      /serotipo\s*1/i.test(comp) ||
      anal.includes("SER 1");

    // Asegura que no sea "no detectado" (exactamente)
    const isClearlyPositive =
      valTextRaw === "detectado" ||
      valTextRaw === "positivo" ||
      valTextRaw === "alto" ||
      valTextRaw === "muy alto";

    return isSer1 && isClearlyPositive;
  });
}






// autocarga


var allSamples = [];


document.addEventListener('DOMContentLoaded', () => {
  const btn  = document.getElementById('toggleManualBtn');
  const wrap = document.getElementById('manualCsvWrap');
  if (btn && wrap) btn.addEventListener('click', () => wrap.classList.toggle('hidden'));
});

// Si la autocarga falla, mostramos autom√°ticamente la carga manual
function _showManualCsv(){
  const wrap = document.getElementById('manualCsvWrap');
  if (wrap) wrap.classList.remove('hidden');
}





function toISODate(v){
  if (!v) return "";
  const d = new Date(v);
  if (!isNaN(d)) return d.toISOString().slice(0,10);
  const raw = (v.toString().split(" ")[0] || v).replace(/T.*/, "");
  const m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m){ const dd=m[1].padStart(2,'0'), mm=m[2].padStart(2,'0'), yyyy=m[3].length===2?('20'+m[3]):m[3]; return `${yyyy}-${mm}-${dd}`; }
  return raw;
}
function toDisplayDate(iso){ // dd/mm/aaaa
  if (!iso) return '';
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[3]}/${m[2]}/${m[1]}` : iso;
}





// Construye/actualiza legioById a partir de lo que haya disponible
function buildLegioSummary(){
  // 1) Limpiar √≠ndice
  window.legioById = {};

  // 2) Fuente de datos: preferimos allDetails si existe; si no, usamos analyses
  const rows = (Array.isArray(window.allDetails) && window.allDetails.length)
    ? window.allDetails.map(r => ({
        id: String(r["Id Numeric"] || r["Id numeric"] || '').trim(),
        analysis: String(r["Analysis"] || '').toUpperCase(),
        component: String(r["Component Name"] || r.component || '').trim(),
        result_text: r["Result text"] ?? r.result_text ?? '',
        result_value: r["Result value"] ?? r.result_value
      }))
    : (Array.isArray(window.analyses) ? window.analyses.map(a => ({
        id: String(a.id_numeric || '').trim(),
        analysis: String(a.analysis || '').toUpperCase(),
        component: String(a.component || '').trim(),
        result_text: a.result_text || '',
        result_value: a.result_value
      })) : []);

  // 3) Elegimos solo entradas de Legionella y calculamos severidad
  const sevMap = { "OK":0, "poco":1, "positivo":2, "alto":3, "muy alto":4 };

  for (const r of rows){
    if (!r.id) continue;
    // si no tenemos 'analysis', nos vale el componente
    const esLegio = isLegioComponent(r.component) ||
                    /^M-0?21\b|^M-033-AC[123]\b|^M-026-NC1\b/.test(r.analysis);
    if (!esLegio) continue;

    const n = toNumSmart(r.result_value, r.result_text);
    const value = Number(n.num);
    const rawText = n.raw || '';
    const cal = calificarLegio(value, rawText);
    if (!cal) continue;

    const sev = sevMap[cal];
    const prev = window.legioById[r.id];
    if (!prev || sev > prev.sev){
      window.legioById[r.id] = {
        cal, sev,
        display: r.result_text || (Number.isFinite(value) ? String(value) : ''),
        value, rawText
      };
    }
  }

  // 4) Completar con flags de serotipos si tenemos analysesById
  if (window.analysesById && typeof window.analysesById.forEach === 'function'){
    window.analysesById.forEach((items, id) => {
      const det = detectSerotiposEnItems(items);
      if (!window.legioById[id]) window.legioById[id] = {cal:null, sev:-1, display:'', value:NaN, rawText:''};
      window.legioById[id].ser1_detectado   = (det.ser1 === 'Detectado');
      window.legioById[id].ser2_14_detectado = (det.ser2_14 === 'Detectado');
    });
  }
}










// fin autocarga


  // Ajusta din√°micamente el alto de la toolbar para que el mapa empiece justo debajo
  function __sizeMapModal() {
    const toolbar = document.getElementById('mapToolbar');
    const host = document.querySelector('#mapModal .rounded-2xl'); // contenedor blanco
    if (toolbar && host) {
      host.style.setProperty('--map-toolbar-h', toolbar.offsetHeight + 'px');
    }
    // si ya existe 'map' (Leaflet), recalcamos
    if (window.map && typeof window.map.invalidateSize === 'function') {
      setTimeout(()=> window.map.invalidateSize(), 50);
    }
  }

  // Llama a este helper al abrir el modal
  
 function openMapModal() {
  const modal = document.getElementById('mapModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  initMap();                          // crea o reusa _map
  requestAnimationFrame(()=> _map.invalidateSize());
}



  function closeMapModal() {
    const modal = document.getElementById('mapModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }




function isSer1DetectedForId(id){
  const idStr = String(id||"").trim();
  return (window.allDetails || []).some(r => {
    const rid = String(r["Id Numeric"] || r["Id numeric"] || "").trim();
    if (rid !== idStr) return false;
    const a = String(r["Analysis"] || "").toUpperCase();
    const isSer1 = /SEROTIPO\s*1/.test(a) || /^M-033-AC3\b/.test(a);
    if (!isSer1) return false;
    const txt = String(r["Result text"] || "").toLowerCase();
    return /detect/.test(txt) || /positiv/.test(txt);
  });
}



  
 function updateActiveCountBadge(n) {
  const el = document.getElementById('activeCount');
  if (!el) return;
  const total = (typeof n === 'number') ? n : (window.allFiltered || []).length;
  el.textContent = `${total.toLocaleString('es-ES')} muestras activas`;
}


  document.getElementById("fechasIntervalo").onclick = function () {
  const start = prompt("Fecha inicio (DD-MM-YYYY):", "");
  const end   = prompt("Fecha fin (DD-MM-YYYY):", "");
  if (!start || !end) return;

  const startDate = parseDMY(start);
  const endDate   = parseDMY(end);
  if (!startDate || !endDate) {
    alert("Formato de fecha no v√°lido. Usa DD-MM-YYYY.");
    return;
  }
  endDate.setHours(23,59,59,999);

  // guarda estado global
  window._dateFilterRange = { start: startDate, end: endDate };

  // muestra la tabla con TODOS los tipos pero filtrando por fechas
  renderTable( applyDateFilterIfAny(allFiltered) );
};


  
  
  
  
    var tabsContainer = document.getElementById("tabButtons");
    var tabContent = document.getElementById("tabContent");
    var searchTab = document.getElementById("searchTab");
    var searchResults = document.getElementById("searchResults");
    var searchInputPoint = document.getElementById("searchInputPoint");
    var searchInputId = document.getElementById("searchInputId");
    var clearSearch = document.getElementById("clearSearch");
    var modePoint = document.getElementById("modePoint");
    var modeId = document.getElementById("modeId");
    var chartCanvas = document.getElementById("samplesChart");
    var tituloModal = document.getElementById("tituloModal");
    var cerrarModalBtn = document.getElementById("cerrarModalBtn");

    // acordeones refs (se rellenan al abrir modal)
    var btnParams, caretParams, paramsContent;
    var btnHistList, btnHistChart, caretHistList, caretHistChart, histListContent, histChartContent;

    var columns = ["Id Numeric","Sampled date","Sampling point","Collected from","Description","Legio"];
    var dataByType = {};
    var allFiltered = [];
    var allDetails = [];
    var legioById = {};
    var activeType = null;
    var searchBtn = null;
    var incumplBtn = null;
    var puntosBtn = null;
    var histChart = null;
    var samplesChart = null;
	
	
	// √çndice global: id -> 'ISO' | 'IDEX' | 'UNKNOWN'
var envaseById = {};

	
	

//detectar ser 1

// --- Helpers para detectar serotipos leyendo los items de an√°lisis ---

// √çndice de an√°lisis por Id
var analysesById = new Map();

function cleanId(s){
  return String(s || "").trim();
}


function _normCompName(s){
  return (s||"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,""); // quita acentos
}

function _isDetectado(s){
  const v = (s||"").toString().trim().toLowerCase();
  // cubre "detectado", "positivo", "pos", "detec." etc
  return /detect|posit/i.test(v) && !/no\s*detect/i.test(v);
}

function detectSerotiposEnItems(items){
  // Devuelve { ser1: 'Detectado'|'No detectado'|null,
  //           ser2_14: 'Detectado'|'No detectado'|null }
  let ser1 = null, ser2_14 = null;

  (items||[]).forEach(it => {
    const comp = _normCompName(it.component || "");
    const res  = (it.result_text || it.result_value || "").toString();

    // Serotipo 1: admite variantes de texto
    if (/pneumophila.*(sr|ser|serotipo)\s*1\b/.test(comp)) {
      ser1 = _isDetectado(res) ? 'Detectado' : 'No detectado';
    }
    // Serotipo 2-14: admite variantes "2-14" "2-14" "2 a 14" etc.
    if (/pneumophila.*(sr|ser|serotipo)\s*2\s*[-‚Äì]?\s*14\b/.test(comp) ||
        /pneumophila.*(sr|ser|serotipo).*(2\s*a\s*14|2\s*-\s*14)/.test(comp)) {
      ser2_14 = _isDetectado(res) ? 'Detectado' : 'No detectado';
    }
  });

  return { ser1, ser2_14 };
}

// ¬øAlguna muestra del punto tuvo SER 1 detectado?
function anySer1DetectadoEnPunto(sp){
  const key = simple(sp);
  const rows = allFiltered.filter(r => simple(r["Sampling point"]) === key);
  for (const r of rows) {
    const id = String(r["Id Numeric"]||"").trim();
    const items = analysesById.get ? analysesById.get(cleanId(id)) :
                  (analysesById[cleanId(id)] || []);
    const det = detectSerotiposEnItems(items);
    if (det.ser1 === 'Detectado') return true;
  }
  return false;
}


//fin detectar ser 1





    function norm(s){ return String(s==null?"":s).normalize('NFKC').trim(); }
    function normalizeDashes(s){ return norm(s).replace(/[‚Äì‚Äî‚àí‚Äê‚Äí‚Äï]+/g,"-"); }
    function simple(s){ return normalizeDashes(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim(); }
    function isND(txt){ return !!simple(txt).match(/\b(no[- ]?detectad[oa]\.?|n\.?d\.?|nd|no detect\.)\b/); }

    function toNumSmart(val, fallbackText){
      if (fallbackText===undefined) fallbackText="";
      var rawTxt = norm(fallbackText);
      if (isND(val) || isND(rawTxt)) return { num:0, raw: rawTxt || norm(val) };
      var s = norm(val).replace(",", ".");
      var m = s.match(/-?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?/);
      return { num: m ? Number(m[0]) : NaN, raw: rawTxt || s };
    }

    function calificarLegio(valor, rawText){
      if (/<\s*10\b/.test(rawText||"")) return "OK";
      if (!isFinite(valor)) return null;
      if (valor < 10) return "OK";
      if (valor < 100) return "poco";
      if (valor > 10000) return "muy alto";
      if (valor > 1000) return "alto";
      if (valor > 100) return "positivo";
      return null;
    }

    function badge(cal){
      if (!cal) return "";
      var map = { "OK":"b-ok", "poco":"b-poco", "positivo":"b-positivo", "alto":"b-alto", "muy alto":"b-muyalto", "incumple":"b-incumple" };
      return '<span class="badge '+(map[cal]||"")+'">'+cal+'</span>';
    }

    function isLegioComponent(comp){
      var c = simple(comp);
      return c.indexOf("legionella")>-1 && (c.indexOf("recuento")>-1 || c.indexOf("deteccion")>-1 || c.indexOf("spp")>-1 || c.indexOf("pneumophila")>-1 || c.indexOf("sr")>-1);
    }

    function isAerobios(comp, anal){
      var a = String(anal||"").toUpperCase();
      var c = simple(comp);
      var is068 = /^M-068-AC[12]\b/.test(a);
      var is22 = c.indexOf("microorganismos cultivables a 22")>-1 || c.indexOf("22¬∫ c")>-1 || c.indexOf("22 ¬∫c")>-1;
      var is37 = c.indexOf("microorganismos cultivables a 37")>-1 || c.indexOf("37¬∫ c")>-1 || c.indexOf("37 ¬∫c")>-1;
      return is068 && (is22 || is37);
    }

    function findMainRowById(id){
      for (var i=0;i<allFiltered.length;i++){
        if (String(allFiltered[i]["Id Numeric"]||"").trim() === String(id).trim()) return allFiltered[i];
      }
      return null;
    }

    function parseDMY(s){
      if (!s) return null;
      var parts = String(s).trim().split(/[\/\-]/);
      if (parts.length < 3) return null;
      var d = parseInt(parts[0],10);
      var m = parseInt(parts[1],10)-1;
      var y = parseInt(parts[2],10);
      if (y < 100) y += (y >= 70 ? 1900 : 2000);
      var dt = new Date(y, m, d);
      return isNaN(dt.getTime()) ? null : dt;
    }
    function fmtDateOnly(raw){
      var d = parseDMY(raw) || new Date(raw);
      if (!d || isNaN(d)) return String(raw).split(' ')[0];
      var dd = String(d.getDate()).padStart(2,'0');
      var mm = d.toLocaleString('es-ES', { month:'short' });
      var yyyy = d.getFullYear();
      return dd + '-' + mm + '-' + yyyy;
    }

    // ----------  MAIN CSV  ----------
	
	
document.getElementById("csvInputMain").addEventListener("change", async function(e){
  const file = e.target.files && e.target.files[0]; 
  if (!file) return;

  // 1) Leemos con autodetecci√≥n UTF-8/Windows-1252
  const text = await readFileSmartENC(file);

  // 2) Parseamos limpiando encabezados y celdas
  Papa.parse(text, {
    header: true,
    skipEmptyLines: true,
    transformHeader: cleanHeaderENC,
    transform: normCellENC,
    complete: function(res){
      // ‚ö° Igual que antes: nos aseguramos de tener "Test schedule"
      var allRows = (res.data || []).map(function(r){
        return {
          ...r,
          "Test schedule": String(r["Test schedule"] || r["test_schedule"] || "").trim()
        };
      });

      // ============= TU L√ìGICA EXISTENTE (sin cambios) =============
      // Filtrado por LEGIO, groupBy, render, tabs, botones, etc.
      allFiltered = allRows.filter(function(r){ 
        return (r["Job Name"]||"").indexOf("LEGIO")===0; 
      });

      dataByType = _.groupBy(allFiltered, "Sample type");
      var types = Object.keys(dataByType);

      renderChartByType();

      var tabs = document.getElementById("tabButtons");
      tabs.innerHTML = "";
      types.forEach(function(type, i){
        var btn = document.createElement("button");
        btn.textContent = type;
        btn.className = "btn-tab";
        btn.dataset.type = type;
        btn.onclick = function(){
          activeType = type;
          setActiveButton(btn);
          searchTab.classList.add("hidden");
          renderTable(dataByType[type]);
        };
        if (i===0){ activeType = type; btn.classList.add("active"); }
        tabs.appendChild(btn);
      });

      // Bot√≥n TODOS + botones extra (igual que ya ten√≠as)
      const btnAll = document.createElement("button");
      btnAll.textContent = "TODOS";
      btnAll.className = "btn-tab";
      btnAll.onclick = function(){
        activeType = null;
        setActiveButton(btnAll);
        searchTab.classList.add("hidden");
        renderTable( applyDateFilterIfAny(allFiltered) );
      };
      tabsContainer.prepend(btnAll);

      // ‚Ä¶ Incumplimientos / Puntos / Buscar (tu c√≥digo existente) ‚Ä¶

      document.getElementById("tabs").classList.remove("hidden");
      if (types.length) renderTable(dataByType[types[0]]);
    }
  });
});


    function setActiveButton(btn){
      var all = document.querySelectorAll("#tabButtons .btn-tab");
      for (var i=0;i<all.length;i++) all[i].classList.remove("active");
      btn.classList.add("active");
    }

    // ---------- DETAILS CSV 2¬∫----------
// ---------- CSV de AN√ÅLISIS (detalles) ----------
document.getElementById("csvInputDetails").addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  const text = await readFileSmartENC(file);

  Papa.parse(text, {
    header: true,
    skipEmptyLines: true,
    transformHeader: cleanHeaderENC,
    transform: normCellENC,
    complete: (res) => {
      const map = buildHeaderMapENC(res.meta && res.meta.fields ? res.meta.fields : []);

      allDetails = (res.data || []).map((row) => {
        const get = (k) => (row[map[k]] != null ? row[map[k]] : "");
        return {
          "Analysis":       String(get("analysis")     || "").trim(),
          "Component Name": normalizeDashes(String(get("component") || "").trim()),
          "Id Numeric":     String(get("id_numeric")   || "").trim(),
          "Id numeric":     String(get("id_numeric")   || "").trim(),
          "Result text":    String(get("result_text")  || get("result") || "").trim(),
          "Result value":   get("result_value"),
          "Unit":           String(get("unit")         || "").trim(),
        };
      });

      // --- √çndice id -> items ---
      analysesById = new Map();
      allDetails.forEach((r) => {
        const id = cleanId(r["Id Numeric"] || r["Id numeric"]);
        if (!id) return;
        const item = {
          analysis:     String(r["Analysis"]||"").trim(),
          component:    String(r["Component Name"]||"").trim(),
          result_text:  String(r["Result text"]||"").trim(),
          result_value: r["Result value"],
        };
        if (!analysesById.has(id)) analysesById.set(id, []);
        analysesById.get(id).push(item);
      });

      // --- √çndice de ENVASE por Id ---
      if (typeof envaseById !== "object") window.envaseById = {};
      allDetails.forEach((r) => {
        const id = cleanId(r["Id Numeric"] || r["Id numeric"]);
        if (!id) return;
        const analUp = String(r["Analysis"]||"").trim().toUpperCase();
        const comp   = String(r["Component Name"]||"").toLowerCase();
        if (analUp === "ENVASE" && /envase/.test(comp)) {
          const txt  = String(r["Result text"] || r["Result value"] || "").toLowerCase();
          const tipo = /500/.test(txt) || /idex/.test(txt) ? "IDEX"
                    : /(1\s*l|1l|1000)/.test(txt) || /iso/.test(txt) ? "ISO"
                    : "UNKNOWN";
          envaseById[id] = tipo;
        }
      });

      // --- Flags SER 1 / SER 2-14 ---
      analysesById.forEach((items, id) => {
        const det = detectSerotiposEnItems(items);
        if (!legioById[id]) legioById[id] = { cal:null, sev:-1, display:"", value:NaN, rawText:"" };
        legioById[id].ser1_detectado    = (det.ser1 === "Detectado");
        legioById[id].ser2_14_detectado = (det.ser2_14 === "Detectado");
      });

      buildLegioSummary();
      renderChartByType();
      if (activeType && dataByType[activeType]) renderTable(dataByType[activeType]);
    }
  });
});

// ---------- Mapeo flexible de cabeceras (versi√≥n ENC) ----------
function buildHeaderMapENC(fields){
  const n = (s) => String(s).toLowerCase().replace(/\s+/g," ").trim();
  const find = (regs) => {
    for (let i = 0; i < fields.length; i++) {
      const nf = n(fields[i]);
      for (let j = 0; j < regs.length; j++) {
        if (regs[j].test(nf)) return fields[i];
      }
    }
    return null;
  };

  const map = {};
  map.analysis      = find([/^analysis$/, /^ensayo$/, /^m[-_]/, /^test$/]);
  map.component     = find([/^component( name)?$/, /^parameter$/, /^par[a√°]metro$/, /^componente$/, /^determinando?$/]);
  map.id_numeric    = find([/^id numeric$/, /^id num[e√©]rico$/, /^id$/, /^sample( id)?$/, /^muestra( id)?$/]);
  map.result_text   = find([/^result text$/, /^texto de resultado$/, /^resultado( texto)?$/, /^observaciones?$/, /^resultado$/]);
  map.result        = find([/^result$/, /^resultado$/]);
  map.result_value  = find([/^result value$/, /^valor( resultado)?$/, /^value$/, /^resultado num[e√©]rico$/]);
  map.unit          = find([/^unit(s)?$/, /^unidad(es)?$/]);
  if (!map.result_text && map.result) map.result_text = map.result;

  return map;
}


    // ---------- GR√ÅFICO PRINCIPAL (doble barra) ----------
    function renderChartByType(){
      if (!chartCanvas) return;
      var labels = Object.keys(dataByType || {});
      var totals = labels.map(function(t){ return (dataByType[t] || []).length; });
      var positiveCounts = labels.map(function(t){
        var rows = dataByType[t] || [];
        var count = 0;
        rows.forEach(function(r){
          var id = String(r["Id Numeric"]||"").trim();
          var leg = legioById[id];
          if (leg && (leg.value > 100 || ["positivo","alto","muy alto"].includes(leg.cal))) count++;
        });
        return count;
      });
      if (samplesChart){ try { samplesChart.destroy(); } catch(e){} }
      samplesChart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Total muestras', data: totals, backgroundColor: 'rgba(59,130,246,.5)', borderColor:'rgba(59,130,246,1)', borderWidth:1 },
            { label: 'ü¶†Positivos Legionella (>100UFC/L)', data: positiveCounts, backgroundColor: 'rgba(239,68,68,.5)', borderColor:'rgba(239,68,68,1)', borderWidth:1 }
          ]
        },
        options: {
          maintainAspectRatio:false, responsive:true,
          plugins:{ legend:{display:true}, title:{display:false} },
          scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 }}},
          onClick: function(evt){
            var pts = samplesChart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, false);
            if (!pts.length) return;
            var datasetIndex = pts[0].datasetIndex;
            var index = pts[0].index;
            if (datasetIndex !== 1) return; // s√≥lo clic en positivos
            var type = labels[index];
            var rows = (dataByType[type] || []).filter(function(r){
              var id = String(r["Id Numeric"]||"").trim();
              var leg = legioById[id];
              return leg && (leg.value > 100 || ["positivo","alto","muy alto"].includes(leg.cal));
            });
            renderTable(rows);
          }
        }
      });
    }

    // ---------- TABLAS ----------
    function renderTable(rows){ renderTableGeneric(rows, {mode:'normal'}); }
    function renderIncumplimientos(){
      var rows = allFiltered.filter(function(r){
        var id = String(r["Id Numeric"]||"").trim();
        var leg = legioById[id];
        return leg && ["positivo","alto","muy alto"].includes(leg.cal);
      });
      renderTableGeneric(rows, {mode:'incumpl'});
    }
    function getLastPositiveDateForPoint(samplingPoint){
      var spKey = simple(samplingPoint || "");
      var candidates = allFiltered
        .filter(function(r){ return simple(r["Sampling point"]) === spKey; })
        .filter(function(r){
          var id = String(r["Id Numeric"] || "").trim();
          var leg = legioById[id];
          return leg && (leg.value > 100 || ["positivo","alto","muy alto"].includes(leg.cal));
        })
        .map(function(r){ return r["Sampled date"] || ""; })
        .sort(function(a,b){
          var da = parseDMY(a) || new Date(a);
          var db = parseDMY(b) || new Date(b);
          return (db && db.getTime?db.getTime():0) - (da && da.getTime?da.getTime():0);
        });
      return candidates[0] ? fmtDateOnly(candidates[0]) : "";
    }
	
	
	
// Helper robusto: ¬øhubo Serotipo 1 en alg√∫n an√°lisis del punto?
function hasSerotipo1ForPoint(sp){
  // Normalizamos clave
  var key = simple(sp);
  // Recorremos TODAS las muestras del punto
  var rows = allFiltered.filter(function(r){
    return simple(r["Sampling point"]) === key;
  });
  for (var i=0;i<rows.length;i++){
    var id = String(rows[i]["Id Numeric"]||"").trim();
    var lg = legioById[id];
    // Distintos nombres por si tu mapeo usa otra clave
    if (lg && (lg.ser1 === true || lg.serotipo1 === true || lg.ser1_detectado === true)) return true;
    if (lg && typeof lg.ser1 === "string" && /^s[i√≠]$/i.test(lg.ser1)) return true;
    if (lg && typeof lg.serotipo1 === "string" && /^s[i√≠]$/i.test(lg.serotipo1)) return true;
  }
  return false;
}

function renderPuntosPositivos(){
  tabContent.innerHTML = "";

  // Agrupamos SOLO muestras con legio positiva
  var byPoint = {};
  allFiltered.forEach(function(r){
    var id  = String(r["Id Numeric"]||"").trim();
    var leg = legioById[id];
    if (!leg || !(leg.value > 100 || ["positivo","alto","muy alto"].includes(leg.cal))) return;
    var sp = r["Sampling point"] || "";
    (byPoint[sp] = byPoint[sp] || []).push(r);
  });

  // Helpers sobre TODOS los an√°lisis del punto
  function allRowsForPoint(sp){
    var key = simple(sp);
    return allFiltered.filter(function(r){ return simple(r["Sampling point"]) === key; });
  }
  function lastAnalysisDate(sp){
    var all = allRowsForPoint(sp)
      .map(function(r){ return r["Sampled date"]||""; })
      .filter(Boolean)
      .sort(function(a,b){
        var da = parseDMY(a) || new Date(a);
        var db = parseDMY(b) || new Date(b);
        return (db&&db.getTime?db.getTime():0) - (da&&da.getTime?da.getTime():0);
      });
    return all[0] ? fmtDateOnly(all[0]) : "";
  }
  function incumplCount(sp){
    return allRowsForPoint(sp).reduce(function(acc,r){
      var id  = String(r["Id Numeric"]||"").trim();
      var lg = legioById[id];
      return acc + (lg && ["positivo","alto","muy alto"].includes(lg.cal) ? 1 : 0);
    },0);
  }
  function lastPositive(sp){ // {text:string, date:Date|null}
    var dText = getLastPositiveDateForPoint(sp) || "";
    var dObj  = dText ? (parseDMY(dText) || new Date(dText)) : null;
    return { text: dText, date: (dObj && dObj.getTime ? dObj : null) };
  }

  var keys = Object.keys(byPoint);
  var rows = keys.map(function(sp){
    var arr = byPoint[sp];                         // solo positivas
    var counts = {};
    arr.forEach(function(x){
      counts[x["Sample type"]||""] = (counts[x["Sample type"]||""]||0)+1;
    });
    var sampleType = Object.keys(counts).sort(function(a,b){return (counts[b]||0)-(counts[a]||0);})[0] || "";

    // m√°ximos y √∫ltima muestra (para abrir modal)
    var maxLeg = null;
    arr.forEach(function(r){
      var id = String(r["Id Numeric"]).trim();
      var lg = legioById[id];
      if (lg && typeof lg.value === "number") maxLeg = (maxLeg==null ? lg.value : Math.max(maxLeg, lg.value));
    });
    var lastRow = arr.slice().sort(function(a,b){
      var da = parseDMY(a["Sampled date"]) || new Date(a["Sampled date"]);
      var db = parseDMY(b["Sampled date"]) || new Date(b["Sampled date"]);
      return (db&&db.getTime?db.getTime():0) - (da&&da.getTime?da.getTime():0);
    })[0];

    var lastPos = lastPositive(sp);

    return {
      sp: sp,
      spName: getSamplingPointName(sp),
      sampleType: sampleType,
      lastAnalysis: lastAnalysisDate(sp),
      lastPositiveText: lastPos.text,          // para mostrar
      lastPositiveDate: lastPos.date,          // para ordenar
      totalAnalyses: allRowsForPoint(sp).length,
      incumpl: incumplCount(sp),
      //maxLeg: maxLeg,
	  maxLeg: (maxLeg > 10000 ? "üëâ " : "") + maxLeg,

      ser1: anySer1DetectadoEnPunto(sp) ? "üëâS√≠" : "No",
      lastRow: lastRow
    };
  })
  // ORDEN: m√°s antiguos primero (sin positivos al final)
  .sort(function(a,b){
    var ta = a.lastPositiveDate ? a.lastPositiveDate.getTime() : Infinity;
    var tb = b.lastPositiveDate ? b.lastPositiveDate.getTime() : Infinity;
    return ta - tb; // ascendente => antiguo primero
  });

  // Tabla
  var wrapper = document.createElement("div");
  var table = document.createElement("table");
  table.className = "table";
  table.innerHTML =
    "<thead><tr>"
    + [
        "Sampling point",
        "Sample type",
        "Fecha √∫ltimo an√°lisis",
        "Fecha √∫ltimo positivo",
        "N¬∫ an√°lisis",
        "N¬∫ incumplimientos (Legio)",
        "Legionella m√°xima",
        "Ser 1 detectado"
      ].map(function(h){ return "<th>"+h+"</th>"; }).join("")
    + "</tr></thead>";

  var tbody = document.createElement("tbody");
  rows.forEach(function(r){
    var tr = document.createElement("tr");
    tr.innerHTML =
      "<td>"+(r.spName || r.sp || "")+"</td>"
      + "<td>"+(r.sampleType||"")+"</td>"
      + "<td>"+(r.lastAnalysis||"")+"</td>"
      + "<td>"+(r.lastPositiveText||"")+"</td>"
      + "<td>"+(r.totalAnalyses||0)+"</td>"
      + "<td>"+(r.incumpl||0)+"</td>"
      + "<td>"+(r.maxLeg!=null ? r.maxLeg : "")+"</td>"
      + "<td>"+r.ser1+"</td>";

    // Toda la fila abre detalle (usando la √∫ltima muestra conocida)
    tr.addEventListener("click", function(){ if (r.lastRow) mostrarDetalleMuestra(r.lastRow); });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrapper.appendChild(table);
  tabContent.appendChild(wrapper);
}


	
	

    function renderTableGeneric(rows, cfg){ 
	updateActiveCountBadge(rows.length);
	window.currentRows = Array.isArray(rows) ? rows : [];
      var mode = cfg && cfg.mode ? cfg.mode : "normal";
      searchTab.classList.add("hidden");
      tabContent.innerHTML = "";
      var table = document.createElement("table");
      table.className = "min-w-full text-sm border border-gray-300";
	  table.classList.add('striped'); 
      var colsBase = ["Id Numeric","Sampled date","Sampling point","Collected from","Description","Legio"];
      var colsInc  = ["Sample type","√öltimo positivo (punto)"];
      var cols = (mode==='incumpl') ? colsBase.concat(colsInc) : colsBase;
      var thead = document.createElement("thead");
      thead.innerHTML = "<tr class='bg-gray-200'>" + cols.map(function(c){return "<th class='p-2 border'>"+c+"</th>";}).join("") + "</tr>";
      table.appendChild(thead);
      var tbody = document.createElement("tbody");
      rows.sort(function(a,b){ return (+a["Id Numeric"]) - (+b["Id Numeric"]); }); 
	 tbody = document.createElement("tbody");
// ordena por Id num√©rico, se mantiene
rows.sort(function(a,b){ return (+a["Id Numeric"]) - (+b["Id Numeric"]); });
let prevKey = null;
let toggle  = false; // false -> A, true -> B
rows.forEach(function(row){
  const id  = String(row["Id Numeric"]||"").trim();
  const leg = legioById[id];
  // clave de agrupaci√≥n: el NOMBRE mostrado del sampling point
  const spShown = getSamplingPointName(row["Sampling point"] || "");
  const key = row["Sampling point"] || ""; 

  if (key !== prevKey) { // cambia el grupo -> alterna color
    toggle = !toggle;
    prevKey = key;
  }

  const tr = document.createElement("tr");
  tr.className = "cursor-pointer hover:bg-gray-50 " + (toggle ? "tr-group-b" : "tr-group-a");

  tr.innerHTML = cols.map(function(col){
    if (col === "Sampled date") return "<td class='p-2 border'>"+fmtDateOnly(row[col] || "")+"</td>";
    if (col === "Legio"){
      if (!leg) return "<td class='p-2 border text-xs text-gray-400'></td>";
      return "<td class='p-2 border text-xs'><div class='flex items-center gap-2'>"+badge(leg.cal)+"<span class='text-gray-700'>"+leg.display+"</span></div></td>";
    }
    if (col === "Sample type") return "<td class='p-2 border'>"+(row["Sample type"]||"")+"</td>";
    if (col === "√öltimo positivo (punto)") return "<td class='p-2 border'>"+getLastPositiveDateForPoint(row["Sampling point"])+"</td>";
  if (col === "Sampling point") {
  const idStr   = String(row["Id Numeric"] || "").trim();
  const rawSP   = String(row["Sampling point"] || "").trim();  // el c√≥digo original (D-333‚Ä¶)
  const spShown = getSamplingPointName(rawSP);
  const hand    = (typeof hasSer1ForId === 'function' && hasSer1ForId(idStr)) ? "üëâ " : "";

  return `<td class="p-2 border" title="Sampling point: ${rawSP}">${hand}${spShown}</td>`;
}



    return "<td class='p-2 border'>"+(row[col]||"")+"</td>";
  }).join("");

  tr.addEventListener("click", function(){ mostrarDetalleMuestra(row); });
  tbody.appendChild(tr);
});
      table.appendChild(tbody);
      tabContent.appendChild(table); 
    }

    // ---------- SEARCH ----------
    var searchMode = "point";
    modePoint.addEventListener("click", function(){ searchMode="point"; updateModeUI(); updateSearchResults(); });
    modeId.addEventListener("click", function(){ searchMode="id"; updateModeUI(); updateSearchResults(); });
    function updateModeUI(){
      modePoint.classList.toggle("active", searchMode==="point");
      modeId.classList.toggle("active", searchMode==="id");
      searchInputPoint.classList.toggle("hidden", searchMode!=="point");
      searchInputId.classList.toggle("hidden", searchMode!=="id");
      (searchMode==="point" ? searchInputPoint : searchInputId).focus();
    }
    searchInputPoint.addEventListener("input", _.debounce(updateSearchResults, 150));
    searchInputId.addEventListener("input", _.debounce(updateSearchResults, 150));
    clearSearch.addEventListener("click", function(){ searchInputPoint.value=""; searchInputId.value=""; updateSearchResults(); });
	
	function updateSearchResults(){
  var rows = allFiltered;
  if (searchMode === "point"){
    var q = simple(searchInputPoint.value);
    rows = !q ? allFiltered : allFiltered.filter(function(r){ 
      var code = String(r["Sampling point"] || "").trim();
      var name = (samplingPointjson[code] && samplingPointjson[code].nombre) || "";
      return simple(code).indexOf(q) > -1 || simple(name).indexOf(q) > -1;
    });
  } else {
    var q2 = norm(searchInputId.value);
    rows = !q2 ? allFiltered : allFiltered.filter(function(r){ 
      return String(r["Id Numeric"]||"").trim().indexOf(q2) > -1; 
    });
  }
  renderResultsTable(rows);
}

	
	
   function renderResultsTable(rows){
   window.currentRows = Array.isArray(rows) ? rows : [];
  searchResults.innerHTML = "";
  updateActiveCountBadge(rows.length);

  if (!rows.length){
    searchResults.innerHTML = "<div class='text-sm text-gray-500'>Sin resultados</div>";
    return;
  }

  var table = document.createElement("table");
  table.className = "min-w-full text-sm border border-gray-300";

  var thead = document.createElement("thead");
  var cols = ["Id Numeric","Sampled date","Sampling point","Collected from","Description","Legio"];
  thead.innerHTML = "<tr class='bg-gray-200'>" + cols.map(function(c){
    return "<th class='p-2 border'>" + c + "</th>";
  }).join("") + "</tr>";
  table.appendChild(thead);

  var tbody = document.createElement("tbody");
  rows.sort(function(a,b){ return (+a["Id Numeric"]) - (+b["Id Numeric"]); });

  rows.forEach(function(row){
    var id = String(row["Id Numeric"]||"").trim();
    var leg = legioById[id];
    var tr = document.createElement("tr");
    tr.className = "hover:bg-gray-50 cursor-pointer";

    tr.innerHTML = cols.map(function(col){
      if (col === "Sampled date") {
        return "<td class='p-2 border'>" + fmtDateOnly(row[col] || "") + "</td>";
      }
  if (col === "Sampling point") {
  const idStr = String(row["Id Numeric"] || "").trim();
  const spShown = getSamplingPointName(row["Sampling point"] || "");

  console.log("hola");
  const hand  = hasSer1ForId(idStr) ? "üëâ" : "";
  return "<td class='p-2 border'>" + hand + spShown + "</td>";
}




      if (col === "Legio") {
        if (!leg) return "<td class='p-2 border text-xs text-gray-400'></td>";
        return "<td class='p-2 border text-xs'><div class='flex items-center gap-2'>" + badge(leg.cal) + "<span class='text-gray-700'>" + leg.display + "</span></div></td>";
      }
      return "<td class='p-2 border'>" + (row[col] || "") + "</td>";
    }).join("");

    tr.addEventListener("click", function(){ mostrarDetalleMuestra(row); });
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  searchResults.appendChild(table);
}



// ‚Äî‚Äî‚Äî Filtro de fechas global (opcional) ‚Äî‚Äî‚Äî
window._dateFilterRange = null; // {start:Date, end:Date} o null

function applyDateFilterIfAny(rows){
  const rng = window._dateFilterRange;
  if (!rng) return rows;
  return (rows || []).filter(r=>{
    const d = parseDMY(r["Sampled date"]) || new Date(r["Sampled date"]);
    return d && !isNaN(d) && d >= rng.start && d <= rng.end;
  });
}














    // ---------- MODAL ----------
    function getTempForId(id){
      var rows = allDetails.filter(function(r){ return String(r["Id Numeric"] || r["Id numeric"]).trim() === String(id).trim(); });
      var tRow = null;
      for (var i=0;i<rows.length;i++){ if (norm(rows[i]["Analysis"]).toUpperCase() === "PE-IL-TEMP"){ tRow = rows[i]; break; } }
      if (!tRow) return null;
      var n = toNumSmart(tRow["Result value"], tRow["Result text"]);
      return isFinite(Number(n.num)) ? Number(n.num) : null;
    }






// Normalizador muy tolerante
function _spSimple(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")   // quita acentos
    .replace(/[‚Äì‚Äî‚àí‚Äê‚Äí‚Äï]+/g, "-")                        // guiones raros -> "-"
    .trim().toUpperCase();
}

// √çndice r√°pido: c√≥digo normalizado -> objeto
const _spIndex = {};
if (typeof samplingPointjson === 'object' && samplingPointjson){
  Object.keys(samplingPointjson).forEach(k=>{
    _spIndex[_spSimple(k)] = samplingPointjson[k];
  });
}


/*

// API √∫nica para obtener nombre (o el c√≥digo si no hay nombre)
function getSamplingPointName(code){
console.log(code);
  const key  = String(code || '').trim();
  console.log(key);
  const info = samplingPointjson[key];
  console.log(key);
  console.log(info);
  console.log(info.nombre);
  console.log("fin");
  return (info && info.nombre) ? info.nombre : key;
  
}

*/





    function mostrarDetalleMuestra(muestra){
	
	mapModal.style.zIndex = 10;     // lo manda al fondo
      var contenido = document.getElementById("contenidoDetalle");
      var cabecera = document.getElementById("cabeceraMuestra");
      var chips = document.getElementById("chipsExtra");
      var id = String(muestra && (muestra["Id Numeric"] || muestra["Id numeric"]) || "").trim();
      //tituloModal.textContent = "üß¨ Detalles de la muestra " + id;

const pointCode = muestra["Sampling point"] || "";
const spInfo    = samplingPointjson[pointCode] || {};
const spName    = spInfo.nombre  || pointCode;
const spTipo    = spInfo.tipo    || "‚Äî";
const spSubtipo = spInfo.subtipo || "‚Äî";

tituloModal.innerHTML =
  'üß¨ Detalles de la muestra ' + id +
  ' ‚Äî ' + spName +getSamplingPointName(pointCode)+
  ' <span class="text-gray-500 text-sm">(' + pointCode + ' ¬∑ ' + spTipo + ' ¬∑ ' + spSubtipo + ')</span>';


      // acordeones refs
      btnParams = document.getElementById("btnParams");
      caretParams = document.getElementById("caretParams");
      paramsContent = document.getElementById("paramsContent");
      btnHistList = document.getElementById("btnHistList");
      btnHistChart = document.getElementById("btnHistChart");
      caretHistList = document.getElementById("caretHistList");
      caretHistChart = document.getElementById("caretHistChart");
      histListContent = document.getElementById("histListContent");
      histChartContent = document.getElementById("histChartContent");



// tarjetas de cabecera (a√±adimos 3 m√°s)
var meta = [
  { label: "Sampled date",   value: fmtDateOnly(muestra["Sampled date"] || "‚Äî") },
  { label: "Collected from", value: muestra["Collected from"] || "‚Äî" },
  { label: "Description",    value: muestra["Description"] || "‚Äî" }

  // nuevas:
 
].map(function(m){
  return '<div class="rounded-xl border p-3 bg-gradient-to-b from-gray-50 to-white">' +
           '<div class="text-xs text-gray-500">'+m.label+'</div>' +
           '<div class="font-medium">'+m.value+'</div>' +
         '</div>';
}).join("");

cabecera.innerHTML = meta;


      var delId = allDetails.filter(function(r){
        var raw = r && (r["Id Numeric"] || r["Id numeric"]) || "";
        var s = String(raw).trim();
        if (s === id) return true;
        var n = Number(s), m = Number(id);
        return isFinite(n) && isFinite(m) && Math.trunc(n) === Math.trunc(m);	
      });
	  
	  		// --- SEROTIPOS de esta muestra (si existen en detalles)
const itemsThisId = analysesById.get && analysesById.get(id) ? analysesById.get(id) : [];
const detSer = detectSerotiposEnItems(itemsThisId); // {ser1, ser2_14}

		

      var biocida = null, envase = null;
      for (var i=0;i<delId.length;i++){
        var up = norm(delId[i]["Analysis"]).toUpperCase();
        var comp = delId[i]["Component Name"] || "";
        if (!biocida && up==="BIOCIDA" && /biocida nombre/i.test(comp)) biocida = delId[i];
        if (!envase && up==="ENVASE" && /envase/i.test(comp)) envase = delId[i];
      }
      chips.innerHTML = [
        biocida ? '<span class="chip"><b>Biocida:</b> '+(biocida["Result text"]||"‚Äî")+'</span>' : "",
        envase  ? '<span class="chip"><b>Envase:</b> '+(envase["Result text"]||"‚Äî")+'</span>' : ""
      ].filter(function(x){return !!x;}).join("");

      var unique = {};
      var relevantes = delId.filter(function(row){
        var anal = norm(row["Analysis"] || "").toUpperCase();
        var comp = norm(row["Component Name"] || "");
        var compS = simple(comp);
        var isBasic = ["PE-IL-TEMP","PE-IL-CL","PE-IL-TIAZ","PE-IL-BR-1"].indexOf(anal)>-1;
        var is021  = /^M-0?21\b/.test(anal) && compS.indexOf("pneumophila")>-1 && compS.indexOf("recuento")>-1;
        var is033  = /^M-033-AC[123]\b/.test(anal) && isLegioComponent(comp);
        var is026  = /^M-026-NC1\b/.test(anal) && isLegioComponent(comp);
        var isAero = isAerobios(comp, anal);
        var ok = isBasic || is021 || is033 || is026 || isAero || isLegioComponent(comp);
        if (!ok) return false;
        var key = norm(row["Analysis"]).toUpperCase()+"|"+simple(row["Component Name"]);
        if (unique[key]) return false;
        unique[key] = true;
        return true;
      });

      var filas = relevantes.map(function(row){
        var analysis = String(row["Analysis"]||"").trim();
        var analUp = analysis.toUpperCase();
        var component = String(row["Component Name"]||"").trim();
        var rawRT = String(row["Result text"] || row["Result"] || "‚Äî").trim();
        var resultText = rawRT.replace(/\s+y\s*$/i, "");
        var unit = String(row["Unit"]||"").trim();
        var n1 = toNumSmart(row["Result value"], resultText);
        var n2 = toNumSmart(resultText);
        var value = isFinite(Number(n1.num)) ? Number(n1.num) : Number(n2.num);
        var rawText = n2.raw || n1.raw;
        var esLegio = isLegioComponent(component) || /^M-0(21|33-AC[123]|26-NC1)$/i.test(analysis);
        var cal = esLegio ? calificarLegio(value, rawText) : null;
        var sampleType = String(muestra["Sample type"]||"").toUpperCase().trim();
        var incumple = null;
        if (sampleType==="AG_ACS" && analUp==="PE-IL-TEMP"){
          var combined = (muestra["Description"]||"") + " " + (muestra["Collected from"]||"");
          var isAcum = /acumulador/i.test(combined);
          if (isFinite(value) && (value<50 || (value<60 && isAcum))) incumple = "incumple";
        }
        var badges = [incumple, cal].filter(function(x){return !!x;}).map(badge).join("");
       // return '<div class="row-line"><div class="row-analysis">['+analysis+']</div><div class="row-main"><div class="row-component">'+(component||"<span class=\'text-gray-400\'>‚Äî</span>")+'</div><div class="row-sep">‚Äî</div><div class="row-result">'+resultText+(unit ? " "+unit : "")+'</div></div>'+badges+'</div>';
      // ¬øEsta fila es "Identificaci√≥n de L. pneumophila serotipo 1" y est√° Detectado?
const esSer1Linea =
  /M-033-AC3\b/i.test(analUp) &&         // m√©todo de serotipado 1
  /serotipo\s*1/i.test(component);

const estaDetectado = /\bdetectad/i.test(resultText);

// Prefijo mano si corresponde
const handPrefix = (esSer1Linea && estaDetectado) ? "üëâ " : "";

// Construir nombre a mostrar (con mano si aplica)
const componentShown = handPrefix + (component || "<span class='text-gray-400'>‚Äî</span>");

// Devolver la fila
return '<div class="row-line">'
     +   '<div class="row-analysis">['+analysis+']</div>'
     +   '<div class="row-main">'
     +     '<div class="row-component">'+ componentShown +'</div>'
     +     '<div class="row-sep">‚Äî</div>'
     +     '<div class="row-result">'+ resultText + (unit ? " " + unit : "") +'</div>'
     +   '</div>'
     +   badges
     + '</div>';

	  }).join("");
	  
	  
	  // A√±adir filas expl√≠citas para serotipos si tenemos diagn√≥stico
if (detSer && detSer.ser1) {
  const cal1 = detSer.ser1 === 'Detectado' ? 'positivo' : 'OK';
  filas += '<div class="row-line">' +
             '<div class="row-analysis">[M-033-AC3]</div>' +
             '<div class="row-main">' +
               '<div class="row-component">Identificaci√≥n de L. pneumophila serotipo 1   </div>' +
               '<div class="row-sep">‚Äî</div>' +
               '<div class="row-result">' + detSer.ser1 + '</div>' +
             '</div>' +
             badge(cal1) +
           '</div>';
}
if (detSer && detSer.ser2_14) {
  const cal214 = detSer.ser2_14 === 'Detectado' ? 'positivo' : 'OK';
  filas += '<div class="row-line">' +
             '<div class="row-analysis">[M-033-AC3]</div>' +
             '<div class="row-main">' +
               '<div class="row-component">Identificaci√≥n de L. pneumophila serotipos 2-14</div>' +
               '<div class="row-sep">‚Äî</div>' +
               '<div class="row-result">' + detSer.ser2_14 + '</div>' +
             '</div>' +
             badge(cal214) +
           '</div>';
}
  
	  
	  
	  
	  
      document.getElementById("contenidoDetalle").innerHTML = filas || '<div class="text-sm text-gray-500">No hay par√°metros relevantes para la muestra '+id+'.</div>';

      // ------- HISTORIAL por Sampling point -------
      var samplingPoint = muestra["Sampling point"] || "";
      var spKey = simple(samplingPoint);
      var samePointRows = allFiltered
        .filter(function(r){ return simple(r["Sampling point"]) === spKey; })
        .map(function(r){
          var id2 = String(r["Id Numeric"]||"").trim();
          var leg = legioById[id2];
          var temp = getTempForId(id2);
          var dateStr = r["Sampled date"] || "";
          var dt = parseDMY(dateStr) || new Date(dateStr);
          return { id:id2, dateStr:dateStr, dt:dt, leg:leg, temp:temp };
        })
        .filter(function(r){ return !!r.leg; })
        .sort(function(a,b){ return (a.dt && a.dt.getTime?a.dt.getTime():0) - (b.dt && b.dt.getTime?b.dt.getTime():0); });

      var histList = document.getElementById("histList");
      if (!samePointRows.length){
        histList.innerHTML = '<div class="text-sm text-gray-500 py-2">No hay resultados de Legionella para este punto.</div>';
      } else {
        var items = samePointRows.map(function(r){
          var legBadge = badge(r.leg.cal);
          var tempTxt = (typeof r.temp === "number" && isFinite(r.temp)) ? r.temp.toFixed(1) : "‚Äî";
          return '<div class="hist-grid px-1 py-2 items-center">'+
                   '<div class="text-sm text-gray-500">'+(fmtDateOnly(r.dateStr)||"‚Äî")+'</div>'+
                   '<div><button class="text-blue-600 underline text-sm" data-jump="'+r.id+'" title="Abrir muestra '+r.id+'">ID '+r.id+'</button></div>'+
                   '<div class="flex items-center gap-2 text-sm">'+legBadge+' <span class="text-gray-700">'+r.leg.display+'</span></div>'+
                   '<div class="text-sm">'+tempTxt+'</div>'+
                 '</div>';
        }).join("");
        histList.innerHTML = items;
        var btns = histList.querySelectorAll("[data-jump]");
        for (var b=0;b<btns.length;b++){
          btns[b].addEventListener("click", function(ev){
            var targetId = ev.currentTarget.getAttribute("data-jump");
            var row = findMainRowById(targetId);
            if (row) mostrarDetalleMuestra(row);
          });
        }
      }

      // acordeones: abrir gr√°fico ‚Üí cerrar listado y par√°metros
      btnParams.onclick = function(){
        var wasHidden = paramsContent.classList.contains("hidden");
        paramsContent.classList.toggle("hidden");
        caretParams.textContent = wasHidden ? "‚ñº" : "‚ñ∂";
      };
      btnHistList.onclick = function(){
        var wasHidden = histListContent.classList.contains("hidden");
        histListContent.classList.toggle("hidden");
        caretHistList.textContent = wasHidden ? "‚ñº" : "‚ñ∂";
        if (!wasHidden) return;
        if (!histChartContent.classList.contains("hidden")){
          histChartContent.classList.add("hidden");
          caretHistChart.textContent = "‚ñ∂";
        }
      };
      btnHistChart.onclick = function(){
        var wasHidden = histChartContent.classList.contains("hidden");
        histChartContent.classList.toggle("hidden");
        caretHistChart.textContent = wasHidden ? "‚ñº" : "‚ñ∂";
        if (wasHidden) buildHistChart(samePointRows);
        if (!histListContent.classList.contains("hidden")){
          histListContent.classList.add("hidden");
          caretHistList.textContent = "‚ñ∂";
        }
        if (!paramsContent.classList.contains("hidden")){
          paramsContent.classList.add("hidden");
          caretParams.textContent = "‚ñ∂";
        }
      };
	 // Cerrar gr√°fico
histChartContent.classList.add("hidden");
caretHistChart.textContent = "‚ñ∂";

// Cerrar listado
histListContent.classList.add("hidden");
caretHistList.textContent = "‚ñ∂";

// Abrir par√°metros
paramsContent.classList.remove("hidden");
caretParams.textContent = "‚ñº";

	  
	  

      abrirModal();
    }

var histChart = null;


    function buildHistChart(rows){
	
	var ctx = document.getElementById("histChart").getContext("2d");

  // üîπ Destruir gr√°fico previo si existe
  if (histChart) {
    histChart.destroy();
    histChart = null;
  }
	
	
	
      var labels = rows.map(function(r){ return r.dateStr || ""; });
      var legValues = rows.map(function(r){
        var v = (typeof r.leg.value === "number" ? r.leg.value : NaN);
        return (isFinite(v) ? (v <= 0 ? 1 : v) : null);
      });
      var legRaw = rows.map(function(r){ return (typeof r.leg.value === "number" ? r.leg.value : null); });
      var temps = rows.map(function(r){ return (typeof r.temp === "number" ? r.temp : null); });
      var th50 = labels.map(function(){ return 50; });

      var threeYearsAgo = new Date();
      threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
      var idx3y = -1, bestDiff = Infinity;
      rows.forEach(function(r, i){
        var diff = Math.abs(((r.dt && r.dt.getTime)?r.dt.getTime():0) - threeYearsAgo.getTime());
        if (diff < bestDiff){ bestDiff = diff; idx3y = i; }
      });

      var ctx = document.getElementById("histChart").getContext("2d");
      if (histChart){ try { histChart.destroy(); } catch(e){} }
      var verticalLinePlugin = {
        id: 'verticalLine3Years',
        afterDraw: function(chart, args, opts){
          if (opts.index == null || opts.index < 0) return;
          var xScale = chart.scales.x;
          var x = xScale.getPixelForValue(opts.index);
          var ctxp = chart.ctx;
          ctxp.save();
          ctxp.beginPath();
          ctxp.moveTo(x, chart.chartArea.top);
          ctxp.lineTo(x, chart.chartArea.bottom);
          ctxp.setLineDash([4,3]);
          ctxp.lineWidth = 1;
          ctxp.strokeStyle = '#9CA3AF';
          ctxp.stroke();
          ctxp.restore();
        }
      };

      histChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Legionella (ufc/L)', data: legValues, yAxisID: 'yLegio', tension: 0.2, pointRadius: 2 },
            { label: 'Temperatura (¬∞C)', data: temps, yAxisID: 'yTemp', tension: 0.2, pointRadius: 2 },
            { label: 'Umbral 50¬∞C', data: th50, yAxisID: 'yTemp', pointRadius: 0, borderDash: [6,4] }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                title: function(ctx){ return ctx[0] && ctx[0].label ? fmtDateOnly(ctx[0].label) : ''; },
                label: function(ctx){
                  var ds = ctx.dataset.label || '';
                  if (ds.indexOf('Legionella')>-1){
                    var raw = legRaw[ctx.dataIndex];
                    return ds + ': ' + (raw === 0 ? '0 (ND)' : raw);
                  }
                  return ds + ': ' + ctx.parsed.y;
                }
              }
            },
            verticalLine3Years: { index: idx3y }
          },
          scales: {
            yLegio: { type: 'logarithmic', position: 'left', min: 1, title: {display:true, text:'ufc/L (log)'} },
            yTemp:  { type: 'linear', position: 'right', title: {display:true, text:'¬∞C'}, grid:{drawOnChartArea:false} }
          }
        },
        plugins: [verticalLinePlugin]
      });
    }






    function abrirModal(){
      document.getElementById("modalDetalle").classList.remove("hidden");
    }
    if (cerrarModalBtn){
      cerrarModalBtn.addEventListener("click", function(){
        document.getElementById("modalDetalle").classList.add("hidden");
      });
    }
    document.addEventListener("keydown", function(e){
      if (e.key === "Escape") document.getElementById("modalDetalle").classList.add("hidden");
    });
	
	
	
	
	
	var samplingPointjson ={
  "D-1001": {
    "nombre": "CC Zabalgana ACS",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-1018": {
    "nombre": "Fuente orn La Rosaleda de Arriaga",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8606933852556, -2.681133443611]
  },
  "D-1019": {
    "nombre": "Residencia Roure ACS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1030": {
    "nombre": "Cami√≥n cisterna limpieza",
    "tipo": "VLV",
    "subtipo": "VLV"
  },
  "D-1031": {
    "nombre": "Barredora con aerosolizaci√≥n",
    "tipo": "VLV",
    "subtipo": "VLV"
  },
  "D-1032": {
    "nombre": "Residencia Lovi",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1033": {
    "nombre": "Fuente ornamental Pza Sta Barbara grulla",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84522965543591, -2.66672613884827]
  },
  "D-1034": {
    "nombre": "Fuente Pza Sim√≥n Bolivar",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.848548846772395, -2.66269560942619]
  },
  "D-1037": {
    "nombre": "ES Gorbea Urartea",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.86385285133459, -2.7131673398750]
  },
  "D-1038": {
    "nombre": "ES Foronda lavacoches",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.895869420260155, -2.70190084230467]
  },
  "D-1039": {
    "nombre": "Centro de dia Blas de Otero",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1040": {
    "nombre": "EI Zaramaga ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1041": {
    "nombre": "Polideportivo Aranako",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1042": {
    "nombre": "CP Santa LUCIA ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1043": {
    "nombre": "Ceip Mariturri ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1044": {
    "nombre": "CEIP Angel Ganivet ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1045": {
    "nombre": "CEIP Aldaialde ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1047": {
    "nombre": "ACS Polideportivo El Campillo",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1048": {
    "nombre": "ACS Fronton Abetxuko",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1054": {
    "nombre": "Hotel Jardines Uleta ACS",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1057": {
    "nombre": "ACS Padel Jundiz",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1058": {
    "nombre": "ACS Vivagym",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1059": {
    "nombre": "ACS Padel norte",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1060": {
    "nombre": "Hotel Libere",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1061": {
    "nombre": "Residencia Aitona Urederra bi 25",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1062": {
    "nombre": "Centro Mayores S Martin AFCH",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1064": {
    "nombre": "Hotel Centro Vitoria ACS",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1066": {
    "nombre": "Centro de Mayores San Martin ACS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1067": {
    "nombre": "Fuente ornam Monasterio Leyre",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.86468306402665, -2.69745161280294]
  },
  "D-1068": {
    "nombre": "Lavacoches Boulevard",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.86164072247478, -2.6642590193467246]
  },
  "D-1069": {
    "nombre": "Lavacoches BP Salburua",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.8563873145512, -2.656798037682]
  },
  "D-1070": {
    "nombre": "Fuente ornamental hegoalde",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.837365773819, -2.666938703225]
  },
  "D-1071": {
    "nombre": "ES Repsol Lavacoches Vda Cantabrico 8",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.864255534882, -2.6605542376496]
  },
  "D-1072": {
    "nombre": "Olarambe futbol ACS",
    "tipo": "Campo de futbol",
    "subtipo": "ACS"
  },
  "D-1072-2": {
    "nombre": "Olaranbe campo futbol vestuarios abajo",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1073": {
    "nombre": "Fuente ornamental Parque Este Salburua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental"
  },
  "D-1074": {
    "nombre": "Fuente ornamental Boulevard Salburua 10",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental"
  },
  "D-1075": {
    "nombre": "Kirolclub Mendizorrotza ACS",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1076": {
    "nombre": "Gimnasio Fitness Park Vitoria. CC Boulevard",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1077": {
    "nombre": "Centro 3¬∫ edad Arana",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1079": {
    "nombre": "Lavacoches Uritiasolo venta estrella",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.837007718016, -2.65837664748707]
  },
  "D-1080": {
    "nombre": "Lavacoches Iparaguirre",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.836926036184, -2.65971396580518]
  },
  "D-300": {
    "nombre": "ACS Pabell√≥n Deportivo Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-301": {
    "nombre": "ACS Polideportivo Aranalde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302-PO": {
    "nombre": "ACS Polideportivo Abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302-PI": {
    "nombre": "ACS Piscinas abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302": {
    "nombre": "ACS Piscinas Abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-303": {
    "nombre": "ACS Polideportivo Ariznavarra",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-304": {
    "nombre": "ACS Polideportivo Arriaga",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-305": {
    "nombre": "ACS Divino Maestro Colegio",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-306": {
    "nombre": "ACS Polideportivo Landazuri",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-307": {
    "nombre": "ACS CC Aldave",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-309": {
    "nombre": "ACS CC Hegoalde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-310": {
    "nombre": "ACS CC Iparralde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-311": {
    "nombre": "ACS Parque de Gamarra",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-312": {
    "nombre": "ACS CC Judizmendi",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-313": {
    "nombre": "ACS CC Lakua-Sansomendi",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-314": {
    "nombre": "ACS Fundaci√≥n Estadio",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-315": {
    "nombre": "ACS Frontones de Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-316": {
    "nombre": "ACS Polideportivo San Andr√©s",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-317": {
    "nombre": "ACS Residencia Ancianos Arcaia",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-318": {
    "nombre": "ACS Complejo Deportivo Beto√±o",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-318-1": {
    "nombre": "Beto√±o Campo de futbol ACS",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-318-2": {
    "nombre": "Beto√±o vestuarios nuevos",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-318-3": {
    "nombre": "Beto√±o aranako",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-319": {
    "nombre": "ACS Piscinas de Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-320": {
    "nombre": "ACS Residencia Ajuria",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-321": {
    "nombre": "ACS Residencia Hermanitas de los Pobres",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-322": {
    "nombre": "ACS Residencia Juan Pablo I",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-323": {
    "nombre": "ACS Residencia Arana",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-324": {
    "nombre": "ACS Residencia Etxebidea",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-325": {
    "nombre": "ACS Residencia San Prudencio",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-326": {
    "nombre": "ACS Residencia Quavitae Ariznavarra",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-328": {
    "nombre": "ACS Residencia Txagorritxu",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-329": {
    "nombre": "ACS Residencia Metroces",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-331": {
    "nombre": "ACS Hotel Ciudad de Vitoria",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-332": {
    "nombre": "ACS Hotel Gran H Lakua",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-333": {
    "nombre": "ACS Hotel Gobeo Park",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-334": {
    "nombre": "ACS Hotel General Alava",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-335": {
    "nombre": "ACS Hotel Ruta de Europa",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-336": {
    "nombre": "ACS Residencia Aurora",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-337": {
    "nombre": "ACS Residencia Los Arquillos",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-338": {
    "nombre": "Torre Centro Comercial Boulevard",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.861657250, -2.6675392237]
	
  },
  "D-341": {
    "nombre": "Torre Quavitae Residencia",
    "tipo": "Residencia",
    "subtipo": "Torre",
	"coords": [42.839848710, -2.6955310886]
	},
  "D-352": {
    "nombre": "Torre Dendaraba",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.84506716339, -2.66844821933],
	"email":"h@hidrocontrol.net"
  },
  "D-353": {
    "nombre": "Torre Centro Comercial Lakua",
    "tipo": "Centro comercial",
    "subtipo": "Torre"
  },
  "D-359": {
    "nombre": "Torre El Corte Ingles",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.84481312339, -2.667879550615]
  },
  "D-361": {
    "nombre": "Torre Edificio Opera",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords":[42.844118976004, -2.67049272406319],
	"email":"sonia_lacuesta@hotmail.com"
  },
  "D-363": {
    "nombre": "Torre EDAR de Crispijana",
    "tipo": "Varios",
    "subtipo": "Torre",
	"coords":[42.853361372348644, -2.741892889055],
	"email":"raul.cerezo@dam-aguas.es"
  },
  "D-365": {
    "nombre": "ACS Residencia los Molinos",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-366": {
    "nombre": "ACS Hotel Almoneda",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-367": {
    "nombre": "ACS Hotel Amarica",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-368": {
    "nombre": "ACS Hotel Barrachi",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-369": {
    "nombre": "ACS Hotel Boulevard",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-370": {
    "nombre": "ACS Hotel Canciller Ayala",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-371": {
    "nombre": "ACS Hotel Dato",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-372": {
    "nombre": "ACS Hotel Desiderio",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-373": {
    "nombre": "ACS Hotel Duque de Wellington",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-374": {
    "nombre": "ACS Hotel El Caser√≥n",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-375": {
    "nombre": "ACS CCIbaiondo",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-376": {
    "nombre": "ACS Hotel Gorbea",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-377": {
    "nombre": "ACS Hotel Holiday Inn Express",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-378": {
    "nombre": "ACS Hotel Iradier",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-379": {
    "nombre": "ACS Hotel La Bilba√≠na",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-380": {
    "nombre": "ACS Hotel La Zuyana",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-381": {
    "nombre": "ACS Hotel Palacio de Elorriaga",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-382": {
    "nombre": "ACS Atlas",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-1": {
    "nombre": "Atlas ACS circuito balneario",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-2": {
    "nombre": "Atlas ACS circuito sala botiquin",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-3": {
    "nombre": "Atlas ACS circuito gimnasio",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-383": {
    "nombre": "ACS Pensi√≥n Casa 400",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-384": {
    "nombre": "ACS Hotel Achuri",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-386": {
    "nombre": "ACS Hydra Boulevard",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-387": {
    "nombre": "ACS Gimnasio K2",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-389": {
    "nombre": "ACS La Pe√±a Vitoriana",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-392": {
    "nombre": "ACS Bakh",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-394": {
    "nombre": "ACS Piscinas Olabide",
    "tipo": "Centro educativo",
    "subtipo": "ACS"
  },
  "D-395": {
    "nombre": "ACS Residencia Colisee Mi√±ano",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-396": {
    "nombre": "ACS Residencia Ari√±ez",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-397": {
    "nombre": "ACS Residencia Otazu",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-398": {
    "nombre": "ACS Residencia Lakua DFA",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-399": {
    "nombre": "ACS Residencia Abetxuko",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-900": {
    "nombre": "Riego Zumabide Aretxabaleta",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-901": {
    "nombre": "Riego Maria Maeztu",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-904": {
    "nombre": "Riego San Martin Bustinzuri",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-905": {
    "nombre": "Riego San Martin interior",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-906": {
    "nombre": "Riego San Martin Lago",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-907": {
    "nombre": "Riego Arana",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-908": {
    "nombre": "Riego Etxezarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-909": {
    "nombre": "Riego Lakuabizkarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-910": {
    "nombre": "Fte or Cuadrilla Vitoria",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8581858242208, -2.6684876878667]
  },
  "D-911": {
    "nombre": "Fte or Parque Norte",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.852662092203, -2.67027008323399]
  },
  "D-912": {
    "nombre": "Fte or Constituci√≥n",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.85499170500697, -2.679168580942587]
  },
  "D-914": {
    "nombre": "Fte or Gazalbide",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.85615851107105, -2.68620833474453]
  },
  "D-915": {
    "nombre": "Fte or Iparralde",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.854741614836, -2.6673658089155]
  },
  "D-916": {
    "nombre": "Fte or Galeon Lakua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8621433816209, -2.6967101023928]
  },
  "D-917": {
    "nombre": "Fte or Juzgados",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84436406402089, -2.68212915304183]
  },
  "D-918": {
    "nombre": "Fte or Resid San Prudencio",
    "tipo": "residencia",
    "subtipo": "Fuente ornamental"
  },
  "D-919": {
    "nombre": "ACS Hotel Catedral",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-920": {
    "nombre": "ACS Residencia Elorri ACS",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-921": {
    "nombre": "Riego Molinuevo",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-922": {
    "nombre": "Fachada vegetal Europa",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-953": {
    "nombre": "ACS Residencia Aitona Etxea",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-958": {
    "nombre": "ACS Restaurante La Brasa",
    "tipo": "bar",
    "subtipo": "ACS"
  },
  "D-959": {
    "nombre": "Lavacoches Elefante Azul",
    "tipo": "Lavacoches",
    "subtipo": "lavacoches",
	"coords":[42.83677872126, -2.6992571823933]
  },
  "D-960": {
    "nombre": "Fuente orn Juan Pablo I",
    "tipo": "residencia",
    "subtipo": "Fuente ornamental"
  },
  "D-966": {
    "nombre": "ACS Centro acogida social municipal",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-976": {
    "nombre": "Riego Aranbizkarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-977": {
    "nombre": "ACS CC Salburua ACS",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-978": {
    "nombre": "Riego Salburua",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-979": {
    "nombre": "Riego parque Zabalgana",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-980": {
    "nombre": "Riego parque Arriaga",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-981": {
    "nombre": "Riego parque el Prado",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-982": {
    "nombre": "Riego Judimendi",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-983": {
    "nombre": "Geiser parque Arriaga",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.86288520850176, -2.6777551121044],
	"email":"paisajeurbano@vitoria-gasteiz.org"
  },
  "D-987": {
    "nombre": "Lavacoches Repsol Trianas",
    "tipo": "gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.83972316552165, -2.66237339976354]
  },
  "D-988": {
    "nombre": "ACS Frontones Lakua 03 ACS",
    "tipo": "Frontones",
    "subtipo": "ACS"
  },
  "D-999": {
    "nombre": "Fuente orn El Cocodrilo",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84518192095005, -2.67831813897868]
  },
  "LEGIO-000": {
    "nombre": "no programada legio",
    "tipo": "Varios",
  },
  "D-1090": {
    "nombre": "RESIDENCIA AGURE - ZABALGANA",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1104": {
    "nombre": "Residencia Ascarza",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1087": {
    "nombre": "RESIDENCIA LAKUA",
    "tipo": "Residencia",
    "subtipo": "AFCH Grifo"
  },
  "D-1105": {
    "nombre": "Residencia Hogar Alav√©s",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1022": {
    "nombre": "RESIDENCIA SAN IGNACIO",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1095": {
    "nombre": "RESIDENCIA TAGORE",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1136": {
    "nombre": "RESIDENCIA PALACIO DE LA BURULLERIA",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1109": {
    "nombre": "Residencia Aiara",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1097": {
    "nombre": "RESIDENCIA ALBERTIA CAMPUS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1110": {
    "nombre": "Residencia geri√°trica El Pilar",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1096": {
    "nombre": "Residencia Mercedarias Egoitza",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1088": {
    "nombre": "Apparthotel passivhaus Kora Green City",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1141": {
    "nombre": "Apartamentos Irenaz",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1082": {
    "nombre": "Lavacoches Onaindia Ptal Arriaga 66",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.86882172453038, -2.67851617247947]
  },
  "D-1107": {
    "nombre": "Lavacoches Ibaia Energy",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.829366137115, -2.7227249333878]
  },
  "D-1108": {
    "nombre": "Lavacoches Ballenoil",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.836060284500, -2.70185318956172]
  },
  "D-319-1": {
    "nombre": "Edificio social Mendizorrotza",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1081": {
    "nombre": "Lavacoches lowcost venta estrella",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.83729173193958, -2.65792664393718]
  },
  "D-313-1": {
    "nombre": "Polidep Lakua03 zona izd",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-313-2": {
    "nombre": "Polidep Lakua 03 zona dcha",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-313-3": {
    "nombre": "Polidep Lakua 03 campo futbol",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1083": {
    "nombre": "Lavacoches CEPSA Dusseldorf",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.852082855295, -2.71001174572264]
  },
  "D-1084": {
    "nombre": "Fuente ornamental Deva",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.858453792584, -2.662314836460]
  },
  "D-1085": {
    "nombre": "Lavacoches Ballenoil Adurza Vitoria2",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.8341511384322, -2.66603482397103]
  },
  "D-1091": {
    "nombre": "Apartamentos Dreampark",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1089": {
    "nombre": "SYNERGYM BORINBIZKARRA",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1086": {
    "nombre": "HOTEL IBIS BUDGET",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1092": {
    "nombre": "Fuente ornamental Abenda√±o",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.846077309158, -2.6835335561616]
  },
  "D-1093": {
    "nombre": "Fuente ornamental Juan de Ayala",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1094 ": {
    "nombre": "Fuente ornamental edificio Aqua Salburua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.853649228732, -2.64932601207691]
  },
  "D-1098": {
    "nombre": "Residencia Senda Corazonistas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1099": {
    "nombre": "Campo de Futbol Adurza",
    "tipo": "Campo de futbol",
    "subtipo": "Aspersores"
  },
  "D-1100": {
    "nombre": "Campo de futbol Adurzabal",
    "tipo": "Campo de futbol",
    "subtipo": "Aspersores"
  },
  "D-1101": {
    "nombre": "Residencia Albertia Iradier",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1102": {
    "nombre": "Residencia Egoitza",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1103": {
    "nombre": "Residencia Goizalde",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1106": {
    "nombre": "Residencia IMQ-Igurco",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1111": {
    "nombre": "Go Gym",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1112": {
    "nombre": "Fitness Gasteiz (Energy Fitness)",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1113": {
    "nombre": "Gimnasio Gasteiz Sport",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1114": {
    "nombre": "Alta Fit Los Herr√°n",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1115 ": {
    "nombre": "Dreamfit Vitoria",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1116": {
    "nombre": "Gimnasio Yin-Yang",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1117": {
    "nombre": "Gimnasio Rodas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1118": {
    "nombre": "Campo de futbol La Vitoriana 01 (cementario)",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-1119": {
    "nombre": "Campo de futbol La Vitoriana 2",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-1120": {
    "nombre": "Campo de futbol Zaramaga",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-390": {
    "nombre": "Polideportivo Land√°zuri (ACS)",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-391": {
    "nombre": "C.C.el Pilar",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-393": {
    "nombre": "ACS Atlas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-385": {
    "nombre": "Pensi√≥n Arriaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-341-2": {
    "nombre": "Quavitae, C/Teodoro G Zarate 14",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-341-1": {
    "nombre": "Quavitae, C/Teodoro G Zarate 14",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-360-1": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-361-2": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-360-2": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-362-1": {
    "nombre": "Gran Hotel Lakua, Tarragona, 8",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-362-2": {
    "nombre": "Gran Hotel Lakua, Tarragona, 8",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-263": {
    "nombre": "RESIDENCIA LOS ARQUILLOS: Paseo de los Arquillos 11 bajo",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-364": {
    "nombre": "Casa de Duchas C/ Correria 106",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-330": {
    "nombre": "BARCELO HOTEL GASTEIZ, Avenida de Gasteiz, 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-302-POLI": {
    "nombre": "Polideportivo Abetxuko ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-319-LUD": {
    "nombre": "Piscinas Mendizorrotza ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-319-SOC": {
    "nombre": "Mendizorrotza Centro Social ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-10047": {
    "nombre": "ACS Polideportivo El Campillo",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-314-2": {
    "nombre": "ESTADIO SD Trinkete ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1115": {
    "nombre": "Dreamfit Vitoria",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1121": {
    "nombre": "Lavacoches Shell Beto√±o",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords": [42.86474837988303, -2.653187043598311]
  },
  "D-1023": {
    "nombre": "ACS Residencia Erantsi",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1124": {
    "nombre": "Lavacoches ES Repsol Portal de Gamarra",
    "tipo": "Legio VLH",
    "subtipo": "Lavacoches",
	"coords": [42.86426268488, -2.66058702907]
  },
  "D-1125": {
    "nombre": "Lavacoches ONA Low cost Portal de Gamarra",
    "tipo": "Legio VLH",
    "subtipo": "Lavacoches",
	"coords":[42.87280547067821, -2.659219718797]
  },
  "D-1126": {
    "nombre": "Synergym San Martin",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1127": {
    "nombre": "Synergym Lakua",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1128": {
    "nombre": "Synergym Zaramaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1129": {
    "nombre": "Synergym Arana",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1130": {
    "nombre": "Basic Fit Portal de Arriaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1131": {
    "nombre": "Alta Fit Guridi",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1132": {
    "nombre": "Cross fit Arana",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1134": {
    "nombre": "Residencia Lorea Txago",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1135": {
    "nombre": "Residencia Carema",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1133": {
    "nombre": "Fuente ornamental 8 marzo",
    "tipo": "Legio FOR",
    "subtipo": "Fuente ornamental",
	"coords":[42.85413331954953, -2.649010004079625]
  },
  "D-1138": {
    "nombre": "Hotel Eire",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1142": {
    "nombre": "Apartamentos Divan",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1139": {
    "nombre": "Aparthotel Jardines de Arizti",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1140": {
    "nombre": "Hotel Limehome",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  }
}
		
	

/**
 * Obtiene la informaci√≥n completa de un punto de muestreo
 * @param {string} code - C√≥digo del Sampling Point (ej: "AG_ACS_001")
 * @returns {object|null} Objeto {nombre, tipo, subtipo} o null si no est√°


 
 */

function getSamplingPointName(code) {
  const cleanCode = String(code || '').trim().toUpperCase();
  const entry = samplingPointjson[cleanCode];

  return (entry && entry.nombre) || cleanCode;
}


// =======================
// === Calendario LIMS ===
// =======================

/**
 * Origen de datos:
 * - Usamos TODAS las muestras, ignorando filtros activos (tal y como quer√≠as).

 */
 

// ===================== CALENDARIO  =====================

// Estado del calendario
let CAL_STATE = { center: null, dayMap: null };


function getCaseDates() {
  return new Set(
    (window.CASES_JSON || [])
      .map(c => keyFromAnyDate(c.date))
      .filter(Boolean)
  );
}



// ---- Casos: fechas seguras (sin UTC) ----
function keyFromAnyDate(v){
  if (!v) return null;
  const s = String(v).trim();

  // ISO -> YYYY-MM-DD
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return `${m[1]}-${m[2]}-${m[3]}`;

  // DMY -> DD[-/]MM[-/]YYYY
  m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m){
    const dd = m[1].padStart(2,'0');
    const mm = m[2].padStart(2,'0');
    const yyyy = m[3].length === 2 ? (parseInt(m[3],10)>=70?('19'+m[3]):('20'+m[3])) : m[3];
    return `${yyyy}-${mm}-${dd}`;
  }
  return null;
}
function fmtDMY(iso){               // -> dd-mm-yyyy
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso||'');
  return m ? `${m[3]}-${m[2]}-${m[1]}` : (iso||'');
}
function dateFromISO(iso){          // fecha local (sin desfases)
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso||'');
  return m ? new Date(+m[1], +m[2]-1, +m[3]) : null;
}
function addDaysISO(iso, days){     // suma/resta d√≠as y devuelve YYYY-MM-DD
  const d = dateFromISO(iso); if(!d) return null;
  d.setDate(d.getDate()+days);
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}





// Convierte "YYYY-MM-DD" o "DD-MM-YYYY" / "DD/MM/YYYY" a "YYYY-MM-DD" sin usar Date
function keyFromAnyDate(v) {
  if (!v) return null;
  const s = String(v).trim();

  // ISO directo
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return `${m[1]}-${m[2]}-${m[3]}`;

  // DMY: 1-9-2025, 01/09/2025, etc.
  m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const dd = m[1].padStart(2, '0');
    const mm = m[2].padStart(2, '0');
    const yyyy = m[3].length === 2 ? (parseInt(m[3],10) >= 70 ? '19'+m[3] : '20'+m[3]) : m[3];
    return `${yyyy}-${mm}-${dd}`;
  }
  return null; // no reconocido
}





// Helper: YYYY-MM-DD desde Date
function ymdKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

// Construye el mapa de muestras por d√≠a: Map<YYYY-MM-DD, Array<info>>
function buildDaySamplesMap(){
  const map = new Map();

  (allFiltered || []).forEach(r=>{
    const d = parseDMY(r["Sampled date"]) || new Date(r["Sampled date"]);
    if (!d || isNaN(d)) return;

    const key = ymdKey(d);
    const id  = String(r["Id Numeric"]||"").trim();

    // tipo de envase detectado del CSV de an√°lisis
    const env = (envaseById && envaseById[id]) ? envaseById[id] : 'UNKNOWN';

    const leg = legioById[id] || null;

    const info = {
      row:  r,
      id:   id,
      env:  (env === 'ISO' || env === 'IDEX') ? env : 'UNKNOWN',
      leg:  leg,
      desc: r["Description"]||"",
      type: r["Sample type"]||"",
      sp:   getSamplingPointName(r["Sampling point"]||"")
    };

    if (!map.has(key)) map.set(key, []);
    map.get(key).push(info);
  });

  return map;
}

// Abre el calendario: meses [actual-2, actual-1, actual]
function openCalendarModal(){
  if (!allFiltered || !allFiltered.length){
    alert("Carga los CSV antes de abrir el calendario.");
    return;
  }
  // construir mapa (depende de envaseById y legioById ya rellenos)
  CAL_STATE.dayMap = buildDaySamplesMap();

  // mes actual a la DERECHA
  const now = new Date();
  CAL_STATE.center = new Date(now.getFullYear(), now.getMonth(), 1);

  renderCalendarMonths();

  const modal = document.getElementById('calendarModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // navegaci√≥n
  document.getElementById('calPrev').onclick = ()=>{
    CAL_STATE.center.setMonth(CAL_STATE.center.getMonth()-1);
    renderCalendarMonths();
  };
  document.getElementById('calNext').onclick = ()=>{
    CAL_STATE.center.setMonth(CAL_STATE.center.getMonth()+1);
    renderCalendarMonths();
  };
}

function closeCalendarModal(){
  const modal = document.getElementById('calendarModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// Dibuja 3 meses: [center-2, center-1, center]. Lunes primero.
function renderCalendarMonths(){
  const title = document.getElementById('calTitle');
  const grid  = document.getElementById('calMonths');
  if (!title || !grid) return;

  const c  = new Date(CAL_STATE.center.getFullYear(), CAL_STATE.center.getMonth(), 1);
  const m2 = new Date(c.getFullYear(), c.getMonth()-2, 1);
  const m1 = new Date(c.getFullYear(), c.getMonth()-1, 1);
  const m0 = c; // actual

  const monthName = d => d.toLocaleDateString('es-ES', {month:'long', year:'numeric'});
  title.textContent = `${monthName(m2)} ‚Äî ${monthName(m0)}`;

  grid.innerHTML = "";

  [m2, m1, m0].forEach(m=>{
    // contenedor de mes
    const monthBox = document.createElement('div');
    monthBox.className = 'cal-month';

    // cabecera
    const hdr = document.createElement('div');
    hdr.className = 'cal-header';
    hdr.textContent = monthName(m);
    monthBox.appendChild(hdr);

    // cabecera d√≠as (L a D)
    const hdrRow = document.createElement('div');
    hdrRow.className = 'cal-grid';
    ['L','M','X','J','V','S','D'].forEach(d=>{
      const c = document.createElement('div');
      c.className = 'cal-dow';
      c.textContent = d;
      hdrRow.appendChild(c);
    });
    monthBox.appendChild(hdrRow);

    // inicio en lunes de la semana del d√≠a 1
    const wd = (m.getDay()+6)%7; // 0..6 (lunes=0)
    const start = new Date(m.getFullYear(), m.getMonth(), 1 - wd);
    const end   = new Date(m.getFullYear(), m.getMonth()+1, 0);
    // √∫ltima celda para completar semanas
    const lastCell = new Date(end.getFullYear(), end.getMonth(), end.getDate() + ((7 - ((end.getDay()+6)%7) - 1 + 7) % 7));
    const todayKey = ymdKey(new Date());

    // rejilla de d√≠as
    const daysGrid = document.createElement('div');
    daysGrid.className = 'cal-grid';

for (let d = new Date(start); d <= lastCell; d.setDate(d.getDate()+1)){
  const key = ymdKey(d);
  const inMonth = (d.getMonth() === m.getMonth());
  const dayCell = document.createElement('div');
  dayCell.className = 'cal-day ' + (inMonth ? 'in' : 'out');
  if (key === todayKey) dayCell.classList.add('today');
  dayCell.textContent = String(d.getDate());

  if (inMonth){
    // ‚Üê SOLO UNA VEZ
    const list = CAL_STATE.dayMap.get(key) || [];

    // caso (‚ö†Ô∏è)
    const hasCase = caseDates.has(key);
    if (hasCase) {
      dayCell.classList.add('has-case');
      dayCell.insertAdjacentHTML('beforeend', ' <span class="case-dot" title="Caso">‚ö†Ô∏è</span>');
    }

    // colores por tipo de muestra (si las hay)
    if (list.length){
      const hasISO     = list.some(x => x.env === 'ISO');
      const hasIDEX    = list.some(x => x.env === 'IDEX');
      const hasUNKNOWN = list.some(x => x.env === 'UNKNOWN');
      if (hasUNKNOWN || (hasISO && hasIDEX)) dayCell.classList.add('has-both');
      else if (hasISO)                        dayCell.classList.add('has-iso');
      else if (hasIDEX)                       dayCell.classList.add('has-idex');
    }

    // clicable si hay muestras O casos
    if (list.length || hasCase) {
      dayCell.onclick = () => renderDayList(key);
    }
  }

  daysGrid.appendChild(dayCell);
}


    monthBox.appendChild(daysGrid);
    grid.appendChild(monthBox);
  });

  // limpiar listado del d√≠a al redibujar
  const listTitle = document.querySelector('#calDayList .day-title');
  const ul = document.querySelector('#calDayList ul');
  if (listTitle) listTitle.textContent = '';
  if (ul) ul.innerHTML = '';
}

// Lista de muestras de un d√≠a
function renderDayList(key){
  const ul = document.querySelector('#calDayList ul');
  const title = document.querySelector('#calDayList .day-title');
  if (!ul || !title) return;

  const list = CAL_STATE.dayMap.get(key) || [];
  const casos = (window.CASES_JSON || []).filter(c => toISODate(c.date) === key);


  // t√≠tulo del d√≠a
  const d = new Date(key + "T00:00:00");
  title.textContent = d.toLocaleDateString('es-ES', {weekday:'long', day:'2-digit', month:'long', year:'numeric'});

  ul.innerHTML = '';

// --- CASOS de este d√≠a ---
const casesToday = (window.CASES_JSON || []).filter(c => {
  const dt = parseDMY(c.date) || new Date(c.date);
  return dt && !isNaN(dt) && ymd(dt) === key;   // key = 'YYYY-MM-DD'
});

if (casesToday.length) {
  // cabecera
  const hdr = document.createElement('li');
  hdr.className = 'text-sm text-amber-700 py-1';
  hdr.innerHTML = '‚ö†Ô∏è <b>Casos de Legionella</b>';
  ul.appendChild(hdr);

  // filas de casos
  casesToday.forEach(c => {
    const dt = parseDMY(c.date) || new Date(c.date);
    const contagio = new Date(dt); contagio.setDate(contagio.getDate() - 15); // 15 d√≠as antes

    const liC = document.createElement('li');
    liC.className = 'px-2 py-1';
    liC.innerHTML = `<div>
        <b>C-${c.id}</b>
        ¬∑ caso ${dt.toLocaleDateString('es-ES')}
        ¬∑ contagio aprox. ${contagio.toLocaleDateString('es-ES')}
      </div>`;
    ul.appendChild(liC);
  });
}

// Si tampoco hay muestras, muestra un mensaje y sal.
if (!list.length && !casesToday.length) {
  ul.innerHTML = "<li class='text-sm text-gray-500'>No hay muestras ni casos este d√≠a</li>";
  return;
}


  // ordenar por Id se puede cambiar la hora
  const rows = list.slice().sort((a,b)=> (+a.id||0) - (+b.id||0));

  rows.forEach(s=>{
    const li = document.createElement('li');

    const envBadge =
      s.env === 'ISO'  ? "<span class='badge iso'>ISO</span>"  :
      s.env === 'IDEX' ? "<span class='badge idex'>IDEX</span>" : "";

    const cal = s.leg ? (badge(s.leg.cal) || '') : '';

    li.innerHTML =
      `<div class="flex items-center justify-between gap-2">
         <div class="truncate">
           <b>${s.sp || '‚Äî'}</b>
           ¬∑ <span class="text-gray-600">ID ${s.id || '-'}</span>
           ¬∑ ${s.type || ''}
           ${s.desc ? ' ‚Äî <span class="text-gray-600">'+s.desc+'</span>' : ''}
         </div>
         <div class="flex items-center gap-2">${cal}${envBadge}</div>
       </div>`;

    li.addEventListener('click', ()=>{
      // cerrar calendario y abrir el modal de la muestra original
      closeCalendarModal();
      if (s.row) { mostrarDetalleMuestra(s.row); }
    });

    ul.appendChild(li);
  });
  
  
  
dayCases.forEach(c => {
  const li = document.createElement('li');
  li.innerHTML = `
    <div class="flex items-center gap-2 text-red-700">
      ‚ò†Ô∏è <span>Caso ${c.id}</span>
    </div>`;
  ul.appendChild(li);
});

  
  // Pinta los casos (nombre/id, fecha y fecha probable de contagio = fecha - 20 d√≠as)
dayCases.forEach(c => {
  const iso = keyFromAnyDate(c.date);
  const fecha = fmtDMY(iso);
  const contagioISO = addDaysISO(iso, -20);
  const contagio = fmtDMY(contagioISO);

  const etiqueta = (c.name && c.name.trim())
    ? c.name.trim()
    : (String(c.id).startsWith('C-') ? String(c.id) : 'C-' + c.id);

  const li = document.createElement('li');
  li.className = 'border border-amber-300 bg-amber-50';
  li.innerHTML = `
    <div class="flex items-center justify-between gap-2">
      <div class="truncate">
        <b>‚ò†Ô∏è ${etiqueta}</b>
        ¬∑ <span class="text-gray-700">${fecha}</span>
        <span class="text-xs text-gray-500 ml-2">(contagio aprox.: ${contagio})</span>
      </div>
    </div>`;
  ul.appendChild(li);
});

  
  
}
// =================== FIN CALENDARIO ===================



//estadisticas
document.getElementById('btnStats')?.addEventListener('click', openStatsModal);

// --- util fechas 
function parseDMY(s) {
  if (!s) return null;
  // espera DD-MM-YYYY (o variantes 
  const m = String(s).match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})/);
  if (!m) return null;
  const d = +m[1], mo = +m[2]-1, y = +m[3] < 100 ? (2000+ +m[3]) : +m[3];
  const dt = new Date(y, mo, d);
  return isNaN(+dt) ? null : dt;
}
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const thisYear = (new Date()).getFullYear();

// --- detectar positivo de Legionella
function isLegioPositive(row) {
  // Si tengolegioById con una bandera fiable lo uso:
  const id = String(row["Id Numeric"] || row.idNumeric || "").trim();
  if (window.legioById && legioById[id] && legioById[id].isPositive !== undefined) {
    return !!legioById[id].isPositive;
  }
  // Fallback: intenta tu ‚Äúcalificaci√≥n‚Äù ya evaluada si existe
  const cal = (row.legCal || row.cal || (window.legioById && legioById[id] && legioById[id].cal) || "").toString().toLowerCase();
  if (cal && cal !== 'ok' && cal !== 'negativo') return true;

  // Fallback extra: si tienes un campo con recuento num√©rico M-033-AC1:
  const rec = parseFloat((row['Legionella spp - Recuento'] || row['M-033-AC1'] || "").toString().replace(',','.'));
  if (!isNaN(rec)) return rec >= 100; // criterio >100 ufc/L

  return false;
}

// --- temperatura ACS: incumplimiento si < 50¬∞C
const ACS_TEMP_TH = 50;
function isAcsTempNonCompliance(row) {
  const type = (row["Sample type"] || row.sampleType || "").toUpperCase();
  if (!type.includes("AG_ACS")) return false;
  const t = parseFloat((row["Temperatura del agua"] || row["PE-IL-TEMP"] || "").toString().replace(',','.'));
  return !isNaN(t) && t < ACS_TEMP_TH;
}

// --- nombre de SP ya no se usa
function SPName(row) {
  return getSamplingPointName(row["Sampling point"] || row.samplingPoint || "");
}

				// nuevo 




/* ====== ESTAD√çSTICA (m√≥dulo √∫nico) ====== */
(() => {
  let _chBySchedule, _chYearEvo, _chTypesYearly, _chScheduleYearly;

  // Helpers locales (no chocan con los tuyos globales)
  const _getYear = d => {
    const dt = (d instanceof Date) ? d : ((window.parseDMY && parseDMY(d)) || new Date(d));
    return dt && !isNaN(dt) ? dt.getFullYear() : null;
  };
  const _getSampleType = r =>
    (r['Sample type'] || r['Type'] || r['Tipo'] || '').toString().trim() || '(sin tipo)';
  const _getSchedule = r =>
    (r['Test schedule'] || r['Test Schedule'] || r['Schedule'] || '').toString().trim() || '(sin plan)';
  const _isLegioPositive = row => {
    const id  = String(row['Id Numeric'] || row.id || '').trim();
    const cal = (window.legioById && window.legioById[id]) ? window.legioById[id].cal : null;
    if (cal != null) return /positivo|alto|muy alto/i.test(String(cal));
    const arr = row.paramsEvaluados || [];
    const p = arr.find(x => /legionella/i.test(x.component||x.key||''));
    if (!p) return false;
    if (typeof p.value === 'number') return p.value > 100;
    return /pos|detect/i.test(String(p.status||p.value||''));
  };

  const _activeRows = () =>
    (window.currentRows && window.currentRows.length ? window.currentRows : (window.allFiltered || [])).slice();

  // ---- Renderizadores ----
  function renderBySchedule(rows){
    const el = document.getElementById('chartBySchedule'); if (!el) return;
    const counts = {};
    rows.forEach(r => { const k = _getSchedule(r); counts[k] = (counts[k]||0)+1; });
    const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
    const data   = labels.map(k => counts[k]);
    if (_chBySchedule) _chBySchedule.destroy();
    _chBySchedule = new Chart(el, {
      type:'bar',
      data:{ labels, datasets:[{ label:'N¬∫ de muestras', data, borderWidth:1 }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        indexAxis:'y',
        plugins:{ legend:{position:'bottom'} },
        scales:{ x:{ grid:{display:true}}, y:{ grid:{display:false}} }
      }
    });
  }

  function renderYearEvolution(rows){
    const sel = document.getElementById('evoTypeSelect');
    const el  = document.getElementById('chartYearEvolution'); if (!sel || !el) return;

    // poblar selector (manteniendo selecci√≥n si existe)
    const tipos = Array.from(new Set(rows.map(r=>_getSampleType(r)))).filter(Boolean).sort();
    const prev = sel.value || '';
    sel.innerHTML = `<option value="">(Todos)</option>` + tipos.map(t=>`<option>${t}</option>`).join('');
    sel.value = prev && tipos.includes(prev) ? prev : '';

    const tipo = sel.value;
    const fil  = tipo ? rows.filter(r => _getSampleType(r)===tipo) : rows;

    // agrupar por a√±o
    const map = new Map(); // y -> {tot,pos}
    fil.forEach(r=>{
      const y = _getYear(r['Sampled date']); if (!y) return;
      if (!map.has(y)) map.set(y, {tot:0,pos:0});
      const s = map.get(y);
      s.tot += 1;
      if (_isLegioPositive(r)) s.pos += 1;
    });

    const years = Array.from(map.keys()).sort((a,b)=>a-b);
    const totals = years.map(y => map.get(y).tot);
    const positives = years.map(y => map.get(y).pos);
    const ratioPct = years.map(y => {
      const s = map.get(y); return s.tot ? (s.pos*100/s.tot) : 0;
    });

    if (_chYearEvo) _chYearEvo.destroy();
    _chYearEvo = new Chart(el, {
      type:'bar',
      data:{
        labels: years,
        datasets:[
          { label:'Total',     data:totals,    borderWidth:1 },
          { label:'Positivos', data:positives, borderWidth:1 },
          // curva extra: ratio %
          { label:'Ratio positivos (%)', data:ratioPct, type:'line', yAxisID:'y1',
            borderWidth:2, pointRadius:3, tension:.25 }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'bottom'} },
        scales:{
          y:{ beginAtZero:true, title:{display:true,text:'n¬∫ muestras'} },
          y1:{ beginAtZero:true, position:'right', suggestedMax:100,
               grid:{ drawOnChartArea:false }, ticks:{ callback:v=>v+' %' },
               title:{display:true, text:'% positivos'} }
        }
      }
    });

    sel.onchange = () => renderYearEvolution(_activeRows());
  }

  function renderTypesPerYear(rows){
    const el = document.getElementById('chartTypesYearly'); if (!el) return;
    const years = new Set(), types = new Set(), grid = {};
    rows.forEach(r=>{
      const y = _getYear(r['Sampled date']); if (!y) return;
      const t = _getSampleType(r);
      years.add(y); types.add(t);
      (grid[y] ||= {}); grid[y][t] = (grid[y][t]||0) + 1;
    });
    const ys = Array.from(years).sort((a,b)=>a-b);
    const ts = Array.from(types).sort();
    const datasets = ts.map(t => ({ label:t, data: ys.map(y => grid[y]?.[t]||0), stack:'types' }));
    if (_chTypesYearly) _chTypesYearly.destroy();
    _chTypesYearly = new Chart(el, {
      type:'bar',
      data:{ labels:ys, datasets },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'} },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, title:{display:true,text:'n¬∫ muestras'} } }
      }
    });
  }

  function renderSchedulePerYear(rows){
    const el = document.getElementById('chartScheduleYearly'); if (!el) return;
    const years = new Set(), schs = new Set(), grid = {};
    rows.forEach(r=>{
      const y = _getYear(r['Sampled date']); if (!y) return;
      const s = _getSchedule(r);
      years.add(y); schs.add(s);
      (grid[y] ||= {}); grid[y][s] = (grid[y][s]||0) + 1;
    });
    const ys = Array.from(years).sort((a,b)=>a-b);
    const ss = Array.from(schs).sort();
    const datasets = ss.map(s => ({ label:s, data: ys.map(y => grid[y]?.[s]||0), stack:'sch' }));
    if (_chScheduleYearly) _chScheduleYearly.destroy();
    _chScheduleYearly = new Chart(el, {
      type:'bar',
      data:{ labels:ys, datasets },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'} },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, title:{display:true,text:'n¬∫ muestras'} } }
      }
    });
  }

  // Rankings (se mantienen como los ten√≠as)
  function renderRankings(rows){
    const now = new Date();
    const from = new Date(now.getFullYear()-3, now.getMonth(), now.getDate());
    const ult3 = rows.filter(r => {
      const d = (window.parseDMY && parseDMY(r['Sampled date'])) || new Date(r['Sampled date']);
      return d && !isNaN(d) && d >= from;
    });

    // Legio+
    const legioByPoint = {};
    ult3.forEach(r => { if (_isLegioPositive(r)) {
      const sp = r['Sampling point']||''; legioByPoint[sp]=(legioByPoint[sp]||0)+1; }});
    const topLegio = Object.entries(legioByPoint).sort((a,b)=>b[1]-a[1]).slice(0,20);
    const ol1 = document.getElementById('rankLegio');
    if (ol1) ol1.innerHTML = topLegio.length
      ? topLegio.map(([sp,c]) => `<li><b>${(window.getSamplingPointName ? getSamplingPointName(sp) : sp)}</b> ‚Äî ${c} positivo(s)</li>`).join('')
      : `<li class="text-gray-500">Sin datos</li>`;

    // Incumpl. temp ACS (si tienes getTempForId)
    const tempByPoint = {};
    ult3.forEach(r=>{
      const type = String(r['Sample type']||'').toUpperCase();
      if (type !== 'AG_ACS') return;
      const id = String(r['Id Numeric']||'').trim();
      const t  = (typeof window.getTempForId === 'function') ? getTempForId(id) : null;
      if (t == null || !isFinite(t)) return;
      const comb = (r['Description']||'') + ' ' + (r['Collected from']||'');
      const esAcum = /acumulador/i.test(comb);
      const incumple = (t < 50) || (esAcum && t < 60);
      if (incumple){ const sp=r['Sampling point']||''; tempByPoint[sp]=(tempByPoint[sp]||0)+1; }
    });
    const topTemp = Object.entries(tempByPoint).sort((a,b)=>b[1]-a[1]).slice(0,20);
    const ol2 = document.getElementById('rankTemp');
    if (ol2) ol2.innerHTML = topTemp.length
      ? topTemp.map(([sp,c]) => `<li><b>${(window.getSamplingPointName ? getSamplingPointName(sp) : sp)}</b> ‚Äî ${c} incumplimiento(s)</li>`).join('')
      : `<li class="text-gray-500">Sin datos</li>`;
  }

  // ---- API p√∫blica del m√≥dulo ----
  window.openStatsModal = function(){
    const m = document.getElementById('statsModal');
    m.classList.remove('hidden'); m.classList.add('flex');

    // dibuja todo con las filas activas
    const rows = _activeRows();
    renderBySchedule(rows);
    renderYearEvolution(rows);        // incluye la curva Ratio (%)
    renderRankings(rows);
    renderTypesPerYear(rows);
    renderSchedulePerYear(rows);
  };
  window.closeStatsModal = function(){
    const m = document.getElementById('statsModal');
    m.classList.add('hidden'); m.classList.remove('flex');
  };
})();






//fin estadisticas

//mapa


/***** =========================
 *  MAPA: puntos + casos
 * ========================== */

//window.CASES_JSON = window.CASES_JSON || [
 // { id: "C-101", date: "2022-08-17", coords: [[42.851, -2.681]] },
 // { id: "C-102", date: "2023-09-03", coords: [[42.848, -2.676], [42.853, -2.672]] },



window.CASES_JSON = [
  { id:"012507", date:"1-9-2025", coords:[[42.857344895, -2.679122517354]] },

	
 { id:"012510", date:"1-9-2025", coords:[[42.85005728526388, -2.6739109319469385]] },

	
	
  { id:"12508", date:"1-8-2025", coords:[[42.852258163666, -2.6642740204784]] },
  { id:"12504", date:"11-7-2025", places:[
      {name:"Casa", coords:[42.84522259460449, -2.6878889321188]},
      {name:"ocio", coords:[42.62942340236879, -2.4920192842449604]}
  ]},
  { id:"12502", date:"6-5-2025", coords:[[42.836970444827, -2.6715088321192]] },
  { id:"12501", date:"2-2-2025", coords:[[42.858946133461, -2.69476884746217]] },
  { id:"12415", date:"23-11-2024", places:[
      {name:"Casa", coords:[42.855020896485, -2.6585674339703]},
      {name:"lavacoche", coords:[42.85687715811913, -2.657028237942318]}
  ]},
  { id:"12413", date:"6-9-2024", places:[
      {name:"Casa", coords:[42.862326033263, -2.6925561934939]},
      {name:"compras", coords:[42.861718798067, -2.69295653904494]}
  ]},
  { id:"12412", date:"19-8-2024", places:[
      {name:"Casa", coords:[42.848086926429, -2.6473519167746]},
      {name:"compras", coords:[42.849801124598365, -2.650248631590642]}
  ]},
  { id:"12410", date:"26-6-2024", coords:[[42.86090410325123, -2.6676440100478938]] },
  { id:"12409", date:"18-6-2024", places:[
      {name:"Casa", coords:[42.861094449805265, -2.695819589790047]},
      {name:"trabajo", coords:[42.836508741039, -2.7288453897912]},
      {name:"ocio", coords:[42.86738554769999, -2.680933031365547]}
  ]},
  { id:"12407", date:"4-6-2024", places:[
      {name:"Casa", coords:[42.842976670396084, -2.6709909474629]},
      {name:"compras", coords:[42.686733393888, -2.94802258878647]}
  ]},
  { id:"12406", date:"29-5-2024", coords:[[42.876481258148, -2.68153728978931]] },
  { id:"12405", date:"28-4-2024", places:[
      {name:"Casa", coords:[42.8382379137123, -2.6647111628071]},
      {name:"trabajo", coords:[42.8608961006692, -2.711218869154049]},
      {name:"compras", coords:[42.834541909526095, -2.6657439408513097]}
  ]},
  { id:"12404", date:"31-3-2024", places:[
      {name:"Casa", coords:[42.85449476655214, -2.668763760954373]},
      {name:"trabajo", coords:[42.8608961006692, -2.711218869154049]},
      {name:"compras", coords:[42.8554633082044, -2.7083698962632]}
  ]},
  { id:"12402", date:"10-3-2024", places:[
      {name:"Casa", coords:[42.854587827011, -2.66913997629841]},
      {name:"trabajo", coords:[42.84367553628, -2.674534476298]}
  ]},
  { id:"12401", date:"9-1-2024", coords:[[42.85563448605, -2.699789160954]] },
  { id:"012312", date:"15-8-2023", coords:[[42.835734411344, -2.66808323582324]] },
  { id:"012310", date:"5-7-2023", coords:[[42.850172196636215, -2.6950778419065635]] },
  { id:"012309", date:"1-7-2023", coords:[[42.84941967383059, -2.706749933970612]] },
  { id:"012311", date:"11-6-2023", coords:[[42.857407813113, -2.67938000883823]] },
  { id:"12306", date:"24-1-2023", places:[
      {name:"Casa", coords:[42.840184905064, -2.667647801431]},
      {name:"compras", coords:[42.849419242284, -2.6763311916425]}
  ]},
  { id:"12305", date:"24-1-2023", places:[
      {name:"Casa", coords:[42.8622115353038, -2.68321216095399]},
      {name:"trabajo", coords:[42.949933271693, -2.64387015116187]},
      {name:"compras", coords:[42.86500514719, -2.6871877548698]}
  ]},
  { id:"12303", date:"17-1-2023", coords:[[42.85666913057, -2.6524369321182]] },
  { id:"12301", date:"6-1-2023", places:[
      {name:"Casa", coords:[42.839729803122, -2.66426915539907]},
      {name:"lavacoche", coords:[42.85687715811913, -2.657028237942318]}
  ]}
];




// ====== Mapa y capas ======



// ====== Globals del mapa (una vez por app) ======
let _map, _initted = false;

// Overlays (deben existir ANTES del control de capas)
const fuenteLayer = L.layerGroup();
const lavaLayer   = L.layerGroup();
const torreLayer  = L.layerGroup();
const casesLayer  = L.layerGroup();
const CASE_STORE = new Map();   // idCaso -> [LayerGroup,...]

// Iconos (emoji) m√°s grandes
const icoFuente = L.divIcon({ className:'ico fuente', html:'‚õ≤Ô∏è', iconSize:[30,30], iconAnchor:[15,15] });
const icoLava   = L.divIcon({ className:'ico lavacoches', html:'üßΩ',  iconSize:[28,28], iconAnchor:[14,14] });
const icoTorre  = L.divIcon({ className:'ico torre', html:'üè¢',     iconSize:[28,28], iconAnchor:[14,14] });
const icoSkull  = L.divIcon({ className:'ico skull', html:'‚ò†Ô∏è',     iconSize:[28,28], iconAnchor:[14,14] });

// Helpers
const _norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function getLatLngFromSp(code){
  const info = (window.samplingPointjson||{})[code]||{};
  const c = info.coords;
  if (!c) return null;
  if (Array.isArray(c) && c.length>=2) return [Number(c[0]), Number(c[1])];
  if (typeof c==='string'){ const m=c.split(','); if (m.length>=2) return [Number(m[0]), Number(m[1])]; }
  if (typeof c==='object'){
    const lat=('lat' in c)?Number(c.lat):null;
    const lng=('lng' in c)?Number(c.lng):('lon' in c?Number(c.lon):null);
    if (lat!=null && lng!=null) return [lat,lng];
  }
  return null;
}
// fallback por si no tienes fmtDateOnly definido antes
function fmtDateOnly(d){
  try { const dt = (d instanceof Date)?d:new Date(d);
        const p=n=>String(n).padStart(2,'0'); return `${p(dt.getDate())}-${p(dt.getMonth()+1)}-${dt.getFullYear()}`; }
  catch{ return d||''; }
}

// Historial para popup
function _rowsOfPoint(code){
  const key = (code||'').toString().trim();
  return (window.allFiltered||[])
    .filter(r => String(r['Sampling point']||'').trim()===key)
    .sort((a,b)=>{
      const da = (window.parseDMY?window.parseDMY(a['Sampled date']):null) || new Date(a['Sampled date']);
      const db = (window.parseDMY?window.parseDMY(b['Sampled date']):null) || new Date(b['Sampled date']);
      return (db?.getTime?.()||0) - (da?.getTime?.()||0);
    });
}


function popupHtmlForPoint(code, info){
  const name  = info?.nombre || code || '';
  const subt  = info?.subtipo || info?.tipo || '';
  const email = (info?.email || info?.mail || '').trim();

  const rows = _rowsOfPoint(code).slice(0,6);
  const lis  = rows.map(r=>{
    const id    = String(r['Id Numeric']||'').trim();
    const fecha = fmtDateOnly(r['Sampled date']||'');
    const chip  = (window.legioById && window.badge) ? badge(legioById[id]?.cal) : '';
    return `<li class="js-open-line" data-id="${id}"
              style="margin:.15rem 0; display:flex; gap:.4rem; align-items:center; cursor:pointer;">
              <span style="min-width:5.2rem; color:#475569">${fecha}</span>
              <span style="min-width:4.5rem; color:#2563eb">ID ${id}</span>
              <span>${chip||''}</span>
            </li>`;
  }).join('') || `<li style="color:#6b7280">Sin muestras cargadas</li>`;

  const emailHtml = email
    ? `<div style="margin-top:.35rem">
         <a href="mailto:${email}" class="mailto"
            onclick="event.stopPropagation()" style="color:#2563eb;text-decoration:underline">üìß ${email}</a>
       </div>`
    : '';

  return `
    <div style="min-width:260px">
      <div style="font-weight:600">${name}</div>
      <div style="color:#6b7280;font-size:12px">${code} ¬∑ ${subt}</div>
      <hr style="margin:.4rem 0; border-color:#e5e7eb">
      <ul style="list-style:none;padding:0;margin:0">${lis}</ul>
      ${emailHtml}
    </div>`;
}


// Pinta/repinta puntos de aerosol
function buildAerosolPoints(){
  fuenteLayer.clearLayers(); lavaLayer.clearLayers(); torreLayer.clearLayers();
  const spjson = window.samplingPointjson || {};
  for (const code in spjson){
    const info = spjson[code]||{};
    const st = _norm(info.subtipo || info.tipo || '');
    let target=null, icon=null;
    if (/\bfuente\b/.test(st))        { target=fuenteLayer; icon=icoFuente; }
    else if (/\blavacoch/.test(st))   { target=lavaLayer;   icon=icoLava;   }
    else if (/\btorre\b/.test(st))    { target=torreLayer;  icon=icoTorre;  }
    else continue;
    const ll = getLatLngFromSp(code); if (!ll) continue;
    L.marker(ll, {icon}).bindPopup(popupHtmlForPoint(code, info)).addTo(target);
  }
  if (_map){
    if(!_map.hasLayer(fuenteLayer)) fuenteLayer.addTo(_map);
    if(!_map.hasLayer(lavaLayer))   lavaLayer.addTo(_map);
    if(!_map.hasLayer(torreLayer))  torreLayer.addTo(_map);
  }
}

// Casos: normalizaci√≥n y pintado
function _normCaseArray(){
  const src = (window.CASES_JSON || window.casosLegio || []);
  return src.map(c=>{
    const id = String(c.id||c.ID||'').replace(/^C-?/i,'');
    const fecha = c.date || c.fecha || c.Fecha || '';
    let points = [];
    if (Array.isArray(c.coords) && c.coords.length){
      points = Array.isArray(c.coords[0]) ? c.coords : [c.coords];
    } else if (c.lat!=null && c.lng!=null){
      points = [[Number(c.lat), Number(c.lng)]];
    }
    return { id, fecha, points };
  }).filter(x=>x.points.length>0);
}

// --- Casos legionelosis ---

 caseDates = new Set(
  (window.CASES_JSON || [])
    .map(c => keyFromAnyDate(c.date))
    .filter(Boolean)
);



function buildCases(){
  casesLayer.clearLayers();
  CASE_STORE.clear();

  const normalized = _normCaseArray(); // [{id, fecha, points:[ [lat,lng], ... ]}]
  normalized.forEach(c=>{
    const groups = [];
    c.points.forEach(ll=>{
      const marker = L.marker(ll, {icon:icoSkull})
                      .bindTooltip(`Caso C-${c.id} ‚Äî ${fmtDateOnly(c.fecha)}`);
      const circle = L.circle(ll,{radius:400,color:'#b91c1c',weight:1,fillColor:'#ef4444',fillOpacity:.15});
      const g = L.layerGroup([circle,marker]).addTo(casesLayer);
      groups.push(g);
    });
    CASE_STORE.set(String(c.id), groups);
  });

  if (_map && !_map.hasLayer(casesLayer)) casesLayer.addTo(_map);
  buildCasesList(normalized);
}

function buildCasesList(casesNorm){
  const box = document.getElementById('casesList');
  if (!box) return;
  box.innerHTML = '';

  // Agrupa por a√±o
  const byYear = {};
  casesNorm.forEach(c => {
    const y = new Date(c.fecha).getFullYear();
    (byYear[y] ||= []).push(c);
  });

  const years = Object.keys(byYear).map(n => +n).sort((a,b) => b - a);
  const latestYear = years[0]; // √∫ltimo a√±o (m√°s reciente)

  // Helper: a√±ade/quita todos los casos de un a√±o
  function setYearVisible(year, on){
    // marca visualmente y activa/desactiva layers
    box.querySelectorAll(`input[type="checkbox"][data-year="${year}"]:not(.chk-year)`).forEach(chk => {
      if (chk.checked !== on) {
        chk.checked = on;
        chk.dispatchEvent(new Event('change'));
      }
    });
    // sincroniza el checkbox de a√±o
    const yearChk = document.getElementById(`chk_year_${year}`);
    if (yearChk) yearChk.checked = on;
  }

  // Construcci√≥n UI por a√±o
  years.forEach(y => {
    // Cabecera con checkbox de A√ëO
    const head = document.createElement('div');
    head.className = 'flex items-center gap-2 mt-2';
    head.innerHTML = `
      <label class="flex items-center gap-2 font-medium">
        <input type="checkbox" id="chk_year_${y}" class="chk-year" data-year="${y}">
        ${y}
      </label>`;
    box.appendChild(head);

    // Lista de casos del a√±o (ordenados por fecha desc)
    byYear[y]
  .sort((a,b)=> (keyFromAnyDate(b.fecha || b.date)).localeCompare(keyFromAnyDate(a.fecha || a.date)))
  .forEach(c => {

      const id = `chk_case_${y}_${c.id}`;
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 pl-6';
      // checked por defecto SOLO si es el √∫ltimo a√±o
      const isChecked = (y === latestYear);
      row.innerHTML = `
        <input type="checkbox" id="${id}" data-id="${c.id}" data-year="${y}" ${isChecked ? 'checked' : ''}>
        ${fmtDMY(keyFromAnyDate(c.fecha || c.date))} ¬∑ ${String(c.id).startsWith('C-') ? c.id : `C-${c.id}`}

      `;
      box.appendChild(row);

      // Wiring del caso
      setTimeout(() => {
        const el = document.getElementById(id);
        if (!el) return;
        el.onchange = (e) => {
          const cid = String(e.target.getAttribute('data-id'));
          const groups = CASE_STORE.get(cid) || [];
          if (e.target.checked) {
            groups.forEach(g => g.addTo(casesLayer));
          } else {
            groups.forEach(g => casesLayer.removeLayer(g));
          }
        };
        // Si no est√° marcado (a√±os antiguos), ocultamos sus layers de inicio
        if (!isChecked) el.dispatchEvent(new Event('change'));
      }, 0);
    });

    // Wiring del checkbox de A√ëO
    setTimeout(() => {
      const yChk = document.getElementById(`chk_year_${y}`);
      if (!yChk) return;
      // Estado por defecto: √∫ltimo a√±o ON, resto OFF
      yChk.checked = (y === latestYear);
      yChk.onchange = (e) => setYearVisible(y, e.target.checked);
      // Asegura visibilidad inicial correcta
      setYearVisible(y, yChk.checked);
    }, 0);
  });

  // MASTER: ‚ÄúTodos los casos‚Äù
  const master = document.getElementById('chkCasesAll');
  if (master){
    // estado inicial: true solo si TODOS los a√±os est√°n activos (en nuestro caso NO)
    master.checked = years.every(y => y === latestYear);

    master.onchange = (e) => {
      const on = e.target.checked;
      years.forEach(y => setYearVisible(y, on));
    };
  }
}



// Toggles de tipos
function attachTypeToggles(){
  const $=id=>document.getElementById(id);
  const on=(chk,layer)=>{$(chk)?.addEventListener('change',e=>{
    if(e.target.checked) layer.addTo(_map); else _map.removeLayer(layer);
  });};
  on('chkFnt',fuenteLayer); on('chkLav',lavaLayer); on('chkTor',torreLayer);
}
// Buscadores
function attachInternalSearch(){
  const el=document.getElementById('mapSearchSp'); if(!el) return;
  el.oninput = _.debounce(()=>{
    const q=_norm(el.value); if(!q) return;
    const spjson=window.samplingPointjson||{};
    const match=Object.keys(spjson).find(k=>{
      const n=(spjson[k].nombre||''); return _norm(k).includes(q)||_norm(n).includes(q);
    });
    if(match){ const ll=getLatLngFromSp(match); if(ll) _map.flyTo(ll,16); }
  },250);
}
function attachStreetSearch(){
  const input=document.getElementById('mapSearchStreet');
  const btn=document.getElementById('btnStreet'); if(!input||!btn) return;
  btn.onclick=async ()=>{
    const q=(input.value||'').trim(); if(!q) return;
    L.Control.Geocoder.nominatim().geocode(q, results=>{
      if(results && results[0]){ const r=results[0].center; _map.flyTo([r.lat,r.lng],16); }
    });
  };
}

// INIT MAP

// globals
let _popupHooked = false;
function initMap(){
  if (_initted) return;
  _initted = true;

  _map = L.map('map', { zoomControl:true }).setView([42.846, -2.674], 13);

  const calles   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                               {maxZoom:19, attribution:'&copy; OpenStreetMap'});
  const simple   = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
                               {maxZoom:20, attribution:'&copy; CartoDB & OpenStreetMap'});
  const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                               {maxZoom:20, attribution:'Tiles &copy; Esri'});
  const relieve  = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                               {maxZoom:17, attribution:'&copy; OpenTopoMap & OpenStreetMap'});

  calles.addTo(_map);

  L.control.layers(
    { 'Calles': calles, 'Simple': simple, 'Sat√©lite': satelite, 'Relieve': relieve },
    null,
    { collapsed:false, position:'bottomleft' }
  ).addTo(_map);

  // ‚¨áÔ∏è Escala: a√±adir aqu√≠ (una sola vez)
  if (!window._scaleCtl) {
    window._scaleCtl = L.control.scale({
      position: 'bottomright', // usa bottomright para no pisar el selector de capas
      metric: true,
      imperial: false,
      maxWidth: 150,
      updateWhenIdle: true
    }).addTo(_map);
  }

  // Contenido + wiring
  buildAerosolPoints();
  buildCases();
  attachTypeToggles();
  attachInternalSearch();
  attachStreetSearch();

  if (!_popupHooked) {
    _map.on('popupopen', onPopupOpen);
    _popupHooked = true;
  }

  setTimeout(()=>_map.invalidateSize(), 50);
}

// handler separado para mantenerlo limpio
function onPopupOpen(ev){
  const root = ev.popup && ev.popup._container;
  if (!root) return;

  // click en toda la fila
  root.querySelectorAll('.js-open-line').forEach(li=>{
    li.addEventListener('click', (e)=>{
      e.preventDefault();
      const id  = li.getAttribute('data-id');
      const row = (typeof findMainRowById==='function') ? findMainRowById(id) : null;
      if (row && typeof mostrarDetalleMuestra==='function') {
        // opcional: cerrar el popup para que no tape
        ev.popup?.remove();
        mostrarDetalleMuestra(row);
      }
    }, { once:true });
  });

  // si hay mailto en el popup, que no burbujee
  root.querySelectorAll('a.mailto').forEach(a=>{
    a.addEventListener('click', e => e.stopPropagation(), { once:true });
  });
  
  
  
  
  
  
  
  
  
}


  
  
  
  
  
  
  
  














// Abrir/cerrar modal
window.openMapModal = function(){
  const modal = document.getElementById('mapModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  if (!_initted) initMap(); else setTimeout(()=>_map.invalidateSize(),50);
};

window.closeMapModal = function(){
  const m=document.getElementById('mapModal'); m.classList.add('hidden'); m.classList.remove('flex');
};



window.closeMapModal = function(){
  const m = document.getElementById('mapModal');
  m.classList.add('hidden'); m.classList.remove('flex');
};


/* ---------- Utilidades ---------- */
function readCoords(v) {
  if (!v) return null;
  if (Array.isArray(v) && v.length >= 2) return [Number(v[0]), Number(v[1])];
  if (typeof v === 'string') {
    const [lat, lng] = v.split(/[ ,]+/).map(s => parseFloat(s));
    if (!isNaN(lat) && !isNaN(lng)) return [lat, lng];
  }
  return null;
}
function formatDMY(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  const p = n => String(n).padStart(2,'0');
  return `${p(dt.getDate())}-${p(dt.getMonth()+1)}-${dt.getFullYear()}`;
}











//fin mapa





	//carga Git
	
	



// === URLs RAW  ===
const URL_SAMPLES  = 'https://raw.githubusercontent.com/gorbea0/LIMS/main/REPORTER_SAMPLE.CSV';
const URL_ANALYSES = 'https://raw.githubusercontent.com/gorbea0/LIMS/main/REPORTER 5oct.CSV';

// Mensajes de estado
function setCsvStatus(msg){
  const el = document.getElementById('remoteCsvMsg');
  if (el) el.textContent = msg || '';
  if (msg) console.info('[CSV]', msg);
}

// Decodifica ISO-8859-1 (Latin-1) y timeout
async function fetchTextWithTimeout(url, ms = 15000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ms);
  const r = await fetch(url, { signal: ctrl.signal });
  clearTimeout(t);
  if (!r.ok) throw new Error(`HTTP ${r.status} en ${url}`);
  const buf = await r.arrayBuffer();
  return new TextDecoder('UTF-8').decode(buf);
}

/**
 * Parse del MAIN (registro) ‚Üí ***MISMO flujo*** que  input manual "csvInputMain":
 *   - normaliza "Test schedule"
 *   - filtra por Job Name que empiece por LEGIO
 *   - agrupa por "Sample type"
 *   - pinta tabs, gr√°fico y tabla inicial
 */
function parseSamplesFromText(csvText){ allSamples
  Papa.parse(csvText, {
    header: true, skipEmptyLines: true, 
    complete: (res) => {
      // Normaliza "Test schedule" para que siempre exista
      const allRows = (res.data || []).map(r => ({
        ...r,
        "Test schedule": String(r["Test schedule"] || r["test_schedule"] || "").trim()
      }));

      // Igual que en handler: solo trabajos LEGIO
      allFiltered = allRows.filter(r => String(r["Job Name"]||"").indexOf("LEGIO") === 0);

      // Agrupa por tipo
      dataByType = _.groupBy(allFiltered, "Sample type");
      const types = Object.keys(dataByType);

      // ‚Äî‚Äî‚Äî Tabs ‚Äî‚Äî‚Äî
      const tabs = document.getElementById("tabButtons");
      tabs.innerHTML = "";

      // Bot√≥n "TODOS" (sin filtrar por tipo; respeta filtro de fechas si existe)
      const btnAll = document.createElement("button");
      btnAll.textContent = "TODOS";
      btnAll.className = "btn-tab";
      btnAll.onclick = function(){
        activeType = null;
        setActiveButton(btnAll);
        document.getElementById('searchTab').classList.add('hidden');
        renderTable( applyDateFilterIfAny(allFiltered) );
      };
      tabs.appendChild(btnAll);

      // Resto de tipos
      types.forEach((type, i) => {
        const btn = document.createElement("button");
        btn.textContent = type;
        btn.className = "btn-tab";
        btn.dataset.type = type;
        btn.onclick = function(){
          activeType = type;
          setActiveButton(btn);
          document.getElementById('searchTab').classList.add('hidden');
          renderTable(dataByType[type]);
        };
        tabs.appendChild(btn);
        if (i === 0) activeType = type;
      });

      // Bot√≥n Incumplimientos
      incumplBtn = document.createElement("button");
      incumplBtn.textContent = "‚ö†Ô∏è Incumplimientos";
      incumplBtn.className = "btn-tab btn-danger";
      incumplBtn.onclick = function(){
        setActiveButton(incumplBtn);
        document.getElementById('searchTab').classList.add("hidden");
        renderIncumplimientos();
      };
      tabs.appendChild(incumplBtn);

      // Bot√≥n Puntos con positivos
      puntosBtn = document.createElement("button");
      puntosBtn.textContent = "üìå Puntos con positivos";
      puntosBtn.className = "btn-tab";
      puntosBtn.onclick = function(){
        setActiveButton(puntosBtn);
        document.getElementById('searchTab').classList.add("hidden");
        renderPuntosPositivos();
      };
      tabs.appendChild(puntosBtn);

      // Bot√≥n Buscar
      searchBtn = document.createElement("button");
      searchBtn.textContent = "üîç Buscar";
      searchBtn.className = "btn-tab";
      searchBtn.onclick = function(){
        setActiveButton(searchBtn);
        document.getElementById('tabContent').innerHTML = "";
        document.getElementById('searchTab').classList.remove("hidden");
        document.getElementById('searchInputPoint').focus();
        updateSearchResults();
      };
      tabs.appendChild(searchBtn);

      document.getElementById("tabs").classList.remove("hidden");

      // Pinta gr√°fico y tabla inicial (igual que manual)
      renderChartByType();
      if (types.length) renderTable(dataByType[types[0]]);
      else renderTable(allFiltered);
	  
	  updateCsvLoadedMessage();
	  
	  
    }
  });
  


}

/**
 * Parse del DETAILS (an√°lisis) ‚Üí ***MISMO flujo*** que tu input manual "csvInputDetails":
 *   - construye allDetails
 *   - rellena analysesById, envaseById y legioById
 *   - actualiza gr√°fico/tabla si ya hay principal
 */
function parseAnalysesFromText(csvText){
  Papa.parse(csvText, {
    header: true, skipEmptyLines: true,
    complete: (res) => {
      // Mapeo encabezados flexible (id√©ntico a tu handler)
      function n(s){ return String(s).toLowerCase().replace(/\s+/g," ").trim(); }
      function find(fields, regs){
        for (let i=0;i<fields.length;i++){
          const nf = n(fields[i]);
          for (let j=0;j<regs.length;j++) if (regs[j].test(nf)) return fields[i];
        }
        return null;
      }
      const fields = res.meta && res.meta.fields ? res.meta.fields : [];
      const map = {
        analysis:     find(fields, [/^analysis$/, /^ensayo$/, /^m[-_]/, /^test$/]),
        component:    find(fields, [/^component( name)?$/, /^parameter$/, /^par[a√°]metro$/, /^componente$/, /^determinando?$/]),
        id_numeric:   find(fields, [/^id numeric$/, /^id num[e√©]rico$/, /^id$/, /^sample( id)?$/, /^muestra( id)?$/]),
        result_text:  find(fields, [/^result text$/, /^texto de resultado$/, /^resultado( texto)?$/, /^observaciones?$/, /^resultado$/]),
        result_value: find(fields, [/^result value$/, /^valor( resultado)?$/, /^value$/, /^resultado num[e√©]rico$/]),
        unit:         find(fields, [/^unit(s)?$/, /^unidad(es)?$/]),
        result:       find(fields, [/^result$/, /^resultado$/])
      };
      if (!map.result_text && map.result) map.result_text = map.result;

      allDetails = res.data.map(row => {
        const get = (k) => row[map[k]] != null ? row[map[k]] : "";
        return {
          "Analysis":       String(get("analysis")     || "").trim(),
          "Component Name": String(get("component")    || "").trim(),
          "Id Numeric":     String(get("id_numeric")   || "").trim(),
          "Id numeric":     String(get("id_numeric")   || "").trim(),
          "Result text":    String(get("result_text")  || get("result") || "").trim(),
          "Result value":   get("result_value"),
          "Unit":           String(get("unit")         || "").trim(),
        };
      });

      // √çndice analysesById
      analysesById = new Map();
      allDetails.forEach(r => {
        const id = String(r["Id Numeric"] || r["Id numeric"] || "").trim();
        if (!id) return;
        const item = {
          analysis:     String(r["Analysis"]||"").trim(),
          component:    String(r["Component Name"]||"").trim(),
          result_text:  String(r["Result text"]||"").trim(),
          result_value: r["Result value"]
        };
        if (!analysesById.has(id)) analysesById.set(id, []);
        analysesById.get(id).push(item);
      });

      // √çndice de envase
      envaseById = {};
      allDetails.forEach(r => {
        const id = String(r["Id Numeric"] || r["Id numeric"] || "").trim();
        const analUp = String(r["Analysis"]||"").trim().toUpperCase();
        const comp   = String(r["Component Name"]||"").toLowerCase();
        if (analUp === "ENVASE" && /envase/.test(comp)) {
          const txt = String(r["Result text"] || r["Result value"] || "").toLowerCase();
          const tipo = /500/.test(txt) || /idex/.test(txt) ? "IDEX"
                   : /(1\s*l|1l|1000)/.test(txt) || /iso/.test(txt) ? "ISO"
                   : "UNKNOWN";
          envaseById[id] = tipo;
        }
      });

      // Resumen de Legionella (usa tu funci√≥n existente)
     // ... ya has rellenado analyses y analysesById
buildLegioSummary();        // <- ahora existe en global
renderChartByType();


      // Enriquecer con serotipos (si tienes detectSerotiposEnItems)
      if (typeof detectSerotiposEnItems === 'function') {
        analysesById.forEach((items, id) => {
          const det = detectSerotiposEnItems(items);
          if (!legioById[id]) legioById[id] = { cal:null, sev:-1, display:"", value:NaN, rawText:"" };
          legioById[id].ser1_detectado    = (det.ser1 === 'Detectado');
          legioById[id].ser2_14_detectado = (det.ser2_14 === 'Detectado');
        });
      }

      // Refresca gr√°fico/tabla si ya hay principal
      renderChartByType();
      if (activeType && dataByType[activeType]) renderTable(dataByType[activeType]);
      else if (allFiltered && allFiltered.length) renderTable(allFiltered);
    }
  });
  
  updateCsvLoadedMessage();
}

// ‚Äî‚Äî‚Äî Autocarga ‚Äî‚Äî‚Äî





async function autoLoadCSVs(){
  try {
    setCsvStatus('Cargando datos del LIMS‚Ä¶');
    const v = `?v=${Date.now()}`;
    const [tMain, tDet] = await Promise.all([
      fetchTextWithTimeout(URL_SAMPLES  + v),
      fetchTextWithTimeout(URL_ANALYSES + v)
    ]);
    parseSamplesFromText(tMain);
    parseAnalysesFromText(tDet);
	
	updateCsvLoadedMessage();


    // pinta si procede y luego muestra el rango
    if (typeof renderAll === 'function') renderAll();
    
	
parseSamplesFromText(tMain);
parseAnalysesFromText(tDet);
updateCsvLoadedMessage();   

	
	
  } catch (err) {
    console.warn('Auto-carga fallida:', err);
    setCsvStatus('No se pudo cargar autom√°ticamente. Usa la carga manual.');
    _showManualCsv?.();
  }
}


// Arranque
document.addEventListener('DOMContentLoaded', autoLoadCSVs);

function updateCsvLoadedMessage() {
  const range = getSamplesDateRange();
  if (range) {
    setCsvStatus(
      `‚úÖ Se han cargado ${allSamples.length} muestras desde ${range.min.toLocaleDateString()} hasta ${range.max.toLocaleDateString()}.`
    );
  } else {
    setCsvStatus("‚ö†Ô∏è No se pudieron determinar las fechas de las muestras.");
  }
}

function fmtISOes(iso){ if(!iso) return ""; const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`; }

function getSamplesDateRange(){
  if (!allSamples || allSamples.length === 0) return null;
  const dates = allSamples
    .map(r => new Date(r["Sampling date"]))
    .filter(d => !isNaN(d));
  if (!dates.length) return null;

  const minDate = new Date(Math.min(...dates));
  const maxDate = new Date(Math.max(...dates));
  return {
    min: minDate.toISOString().slice(0,10),
    max: maxDate.toISOString().slice(0,10),
  };
}



// Muestra el aviso arriba a la derecha
function setCsvStatus(html){
  const el = document.getElementById('remoteCsvMsg');
  if (el) el.innerHTML = `<span class="text-xs text-gray-600">${html}</span>`;
}

// Rango de fechas de las muestras (solo main CSV)
function getSamplesDateRange(){
  // Preferimos allFiltered (ya filtrado LEGIO). Si no est√°, miramos allSamples o currentRows.
  const rows =
    (Array.isArray(window.allFiltered) && window.allFiltered.length) ? window.allFiltered :
    (Array.isArray(window.allSamples)  && window.allSamples.length)  ? window.allSamples  :
    (Array.isArray(window.currentRows) && window.currentRows.length) ? window.currentRows :
    [];

  const dates = rows
    .map(r => parseDMY(r["Sampled date"]) || new Date(r["Sampled date"]))
    .filter(d => d && !isNaN(d));

  if (!dates.length) return null;
  dates.sort((a,b)=>a-b);
  return { min: dates[0], max: dates[dates.length-1] };
}

// Pinta el mensaje ‚Äúcargadas de X a Y‚Äù
function updateCsvLoadedMessage(){
  const rng = getSamplesDateRange();
  if (!rng){
    // No interrumpimos la autocarga; solo avisamos en consola si quieres
    console.warn("[CSV] ‚ö†Ô∏è No se pudieron determinar las fechas de las muestras.");
    setCsvStatus("CSV cargado.");
    return;
  }
  const from = toDisplayDate(rng.min.toISOString().slice(0,10));
  const to   = toDisplayDate(rng.max.toISOString().slice(0,10));
  setCsvStatus(`‚úÖ Se han cargado todas las muestras <b>del ${from} al ${to}</b>.`);
}


	
	
	//fin carga git


	
	
	
</script>
</body>
</html>
